#!/usr/bin/env python3
"""
Malware Scanner - VirusTotal File Scanner
Scan individual files or entire folders for malware using VirusTotal API
"""

import requests
import time
import os
import sys
from pathlib import Path

# ANSI color codes for terminal output
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

def print_banner():
    """Print application banner"""
    print(f"\n{Colors.CYAN}{Colors.BOLD}{'='*60}")
    print("üõ°Ô∏è  MALWARE SCANNER - VirusTotal Edition")
    print(f"{'='*60}{Colors.END}\n")

def get_api_key():
    """Get API key from user"""
    api_key = input(f"{Colors.BOLD}Enter your VirusTotal API key: {Colors.END}").strip()
    if not api_key:
        print(f"{Colors.RED}Error: API key is required!{Colors.END}")
        sys.exit(1)
    return api_key

def scan_file(file_path, api_key):
    """
    Scan a single file using VirusTotal API
    
    Args:
        file_path: Path to the file to scan
        api_key: VirusTotal API key
        
    Returns:
        dict: Scan results or None if failed
    """
    print(f"\n{Colors.BLUE}Scanning: {Colors.WHITE}{file_path}{Colors.END}")
    
    # Check if file exists
    if not os.path.exists(file_path):
        print(f"{Colors.RED}Error: File not found!{Colors.END}")
        return None
    
    # Check file size (VirusTotal free API limit is 32MB)
    file_size = os.path.getsize(file_path)
    if file_size > 32 * 1024 * 1024:
        print(f"{Colors.RED}Error: File too large (max 32MB for free API){Colors.END}")
        return None
    
    print(f"{Colors.CYAN}File size: {file_size / 1024:.2f} KB{Colors.END}")
    
    try:
        # Step 1: Upload file
        print(f"{Colors.YELLOW}‚è≥ Uploading file...{Colors.END}")
        with open(file_path, 'rb') as f:
            files = {'file': f}
            headers = {'x-apikey': api_key}
            
            response = requests.post(
                'https://www.virustotal.com/api/v3/files',
                headers=headers,
                files=files
            )
        
        if response.status_code != 200:
            print(f"{Colors.RED}Upload failed: HTTP {response.status_code}{Colors.END}")
            return None
        
        upload_data = response.json()
        analysis_id = upload_data['data']['id']
        
        # Step 2: Wait for analysis
        print(f"{Colors.YELLOW}‚è≥ Analyzing file (this may take up to 90 seconds)...{Colors.END}")
        max_attempts = 30
        attempt = 0
        
        while attempt < max_attempts:
            time.sleep(3)
            attempt += 1
            
            response = requests.get(
                f'https://www.virustotal.com/api/v3/analyses/{analysis_id}',
                headers={'x-apikey': api_key}
            )
            
            if response.status_code != 200:
                print(f"{Colors.RED}Analysis check failed: HTTP {response.status_code}{Colors.END}")
                return None
            
            result = response.json()
            status = result['data']['attributes']['status']
            
            if status == 'completed':
                return result['data']['attributes']
            
            print(f"{Colors.CYAN}   Attempt {attempt}/{max_attempts}... Status: {status}{Colors.END}")
        
        print(f"{Colors.YELLOW}‚ö†Ô∏è  Analysis timeout - check VirusTotal website manually{Colors.END}")
        return None
        
    except Exception as e:
        print(f"{Colors.RED}Error: {str(e)}{Colors.END}")
        return None

def print_results(file_path, results):
    """
    Print scan results in a formatted way
    
    Args:
        file_path: Path of scanned file
        results: Scan results from VirusTotal
    """
    if not results:
        return
    
    stats = results['stats']
    malicious = stats.get('malicious', 0)
    suspicious = stats.get('suspicious', 0)
    harmless = stats.get('harmless', 0)
    undetected = stats.get('undetected', 0)
    
    # Determine threat level
    if malicious > 0:
        threat_level = "üö® MALICIOUS"
        color = Colors.RED
    elif suspicious > 0:
        threat_level = "‚ö†Ô∏è  SUSPICIOUS"
        color = Colors.YELLOW
    else:
        threat_level = "‚úÖ CLEAN"
        color = Colors.GREEN
    
    # Print summary
    print(f"\n{Colors.BOLD}{'='*60}")
    print(f"SCAN RESULTS: {os.path.basename(file_path)}")
    print(f"{'='*60}{Colors.END}")
    print(f"\n{Colors.BOLD}Threat Level: {color}{threat_level}{Colors.END}\n")
    
    print(f"{Colors.BOLD}Detection Summary:{Colors.END}")
    print(f"  {Colors.RED}Malicious:  {malicious}{Colors.END}")
    print(f"  {Colors.YELLOW}Suspicious: {suspicious}{Colors.END}")
    print(f"  {Colors.GREEN}Clean:      {harmless}{Colors.END}")
    print(f"  {Colors.WHITE}Undetected: {undetected}{Colors.END}")
    
    # Print detected threats
    if malicious > 0 or suspicious > 0:
        print(f"\n{Colors.BOLD}Detected Threats:{Colors.END}")
        engine_results = results.get('results', {})
        
        for engine, result in engine_results.items():
            category = result.get('category', '')
            if category in ['malicious', 'suspicious']:
                detection = result.get('result', 'Unknown')
                status_color = Colors.RED if category == 'malicious' else Colors.YELLOW
                print(f"  {status_color}[{category.upper()}]{Colors.END} {engine}: {detection}")

def scan_folder(folder_path, api_key):
    """
    Scan all files in a folder
    
    Args:
        folder_path: Path to folder to scan
        api_key: VirusTotal API key
    """
    if not os.path.isdir(folder_path):
        print(f"{Colors.RED}Error: Not a valid folder!{Colors.END}")
        return
    
    files = []
    for root, dirs, filenames in os.walk(folder_path):
        for filename in filenames:
            files.append(os.path.join(root, filename))
    
    if not files:
        print(f"{Colors.YELLOW}No files found in folder{Colors.END}")
        return
    
    print(f"{Colors.CYAN}Found {len(files)} file(s) to scan{Colors.END}")
    
    results_summary = []
    
    for idx, file_path in enumerate(files, 1):
        print(f"\n{Colors.BOLD}[{idx}/{len(files)}]{Colors.END}")
        result = scan_file(file_path, api_key)
        
        if result:
            results_summary.append({
                'path': file_path,
                'malicious': result['stats'].get('malicious', 0),
                'suspicious': result['stats'].get('suspicious', 0)
            })
            print_results(file_path, result)
        
        # Rate limiting - wait between files
        if idx < len(files):
            print(f"\n{Colors.CYAN}Waiting 15 seconds before next file (API rate limit)...{Colors.END}")
            time.sleep(15)
    
    # Print overall summary
    print(f"\n{Colors.BOLD}{Colors.CYAN}{'='*60}")
    print("FOLDER SCAN SUMMARY")
    print(f"{'='*60}{Colors.END}")
    
    threats_found = sum(1 for r in results_summary if r['malicious'] > 0 or r['suspicious'] > 0)
    clean_files = len(results_summary) - threats_found
    
    print(f"\nTotal files scanned: {len(results_summary)}")
    print(f"{Colors.GREEN}Clean files: {clean_files}{Colors.END}")
    print(f"{Colors.RED}Files with threats: {threats_found}{Colors.END}")
    
    if threats_found > 0:
        print(f"\n{Colors.RED}{Colors.BOLD}‚ö†Ô∏è  THREATS DETECTED:{Colors.END}")
        for item in results_summary:
            if item['malicious'] > 0 or item['suspicious'] > 0:
                print(f"  {Colors.RED}‚Ä¢ {item['path']}{Colors.END}")

def main():
    """Main application entry point"""
    print_banner()
    
    # Get API key
    api_key = get_api_key()
    
    # Get target path
    print(f"\n{Colors.BOLD}What would you like to scan?{Colors.END}")
    print("1. Single file")
    print("2. Entire folder")
    
    choice = input(f"\n{Colors.BOLD}Enter choice (1 or 2): {Colors.END}").strip()
    
    target_path = input(f"{Colors.BOLD}Enter path: {Colors.END}").strip()
    
    if not target_path:
        print(f"{Colors.RED}Error: Path is required!{Colors.END}")
        sys.exit(1)
    
    # Scan based on choice
    if choice == '1':
        result = scan_file(target_path, api_key)
        if result:
            print_results(target_path, result)
    elif choice == '2':
        scan_folder(target_path, api_key)
    else:
        print(f"{Colors.RED}Invalid choice!{Colors.END}")
        sys.exit(1)
    
    print(f"\n{Colors.GREEN}{Colors.BOLD}‚úì Scan complete!{Colors.END}\n")

if __name__ == "__main__":
    main()
