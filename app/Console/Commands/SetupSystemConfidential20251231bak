<?php



/**

 * ========================================

 * SYSTEM SETUP COMMAND

 * ========================================

 * Run this command to set up the entire system:

 *

 * php artisan system:setup-confidential

 *

 * ========================================

 */



namespace App\Console\Commands;



use App\Models\Document;

use App\Models\Image;

use App\Models\ProtectedFile;

use App\Models\GuitarScore;

use App\Models\User;

use Illuminate\Console\Command;

use Illuminate\Support\Facades\Artisan;

use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\File as FileFacade;

use Illuminate\Support\Facades\Storage;



class SetupSystemConfidential extends Command
{
    protected $signature = 'system:setup-confidential {--skip-protected : Skip protected storage sync} {--skip-guitar : Skip guitar scores sync}';

    protected $description = 'Complete system setup with migrations, user creation, and data rebuild (non-interactive)';


    // ===================================

    // ğŸ” HARD-CODED CREDENTIALS

    // ===================================

    private const ADMIN_NAME = 'markjc';


    private const ADMIN_EMAIL = 'markjc@mweb.co.za';


    private const ADMIN_PASSWORD = 'Qwerpoiu13971@';


    private const IS_SUPER_ADMIN = true;


    private const ADMIN_AVATAR = 'blogpostnewavatar_marksavatar.jpg';  // Avatar filename in storage/app/public/avatars/


    public function handle()

    {

        $this->info('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');

        $this->info('â•‘     SYSTEM SETUP & INITIALIZATION (AUTOMATED)    â•‘');

        $this->info('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        $this->newLine();


        // ===================================

        // â“ ASK REBUILD PREFERENCES UPFRONT

        // ===================================

        $this->info('------------------------------');

        $this->info('â“ Setup Configuration');

        $this->info('------------------------------');

        $this->newLine();


        $this->warn('âš ï¸  Note: Fresh database will drop ALL tables and rebuild everything from scratch.');

        $this->warn('   If you want to preserve existing data, choose "no" for fresh setup.');

        $this->newLine();


        // AUTO-CONFIGURATION: FULL REBUILD
        $freshSetup = true;
        $rebuildDocs = true;
        $rebuildImages = true;
        $rebuildProtected = !$this->option('skip-protected');
        $rebuildGuitarScores = !$this->option('skip-guitar');

        $this->info('âœ… AUTO-REBUILD MODE: Everything will be rebuilt');
        $this->newLine();


        $this->newLine();


        // ===================================

        // ğŸ”‘ GENERATE APPLICATION KEY (FIRST)

        // ===================================

        $this->info('------------------------------');

        $this->info('ğŸ”‘ Generating application key...');

        $this->info('------------------------------');

        $this->newLine();


        $exitCode = $this->call('key:generate', ['--force' => true]);


        if ($exitCode === 0) {

            $this->info('âœ… Application key generated successfully.');

        } else {

            $this->error('âŒ Failed to generate application key!');

            return Command::FAILURE;

        }


        $this->newLine();


        // ===================================

        // ğŸ”„ MIGRATE (FRESH OR NORMAL)

        // ===================================

        $this->info('------------------------------');

        if ($freshSetup) {

            $this->info('ğŸ”„ Running migrate:fresh...');

        } else {

            $this->info('ğŸ”„ Running migrations...');

        }

        $this->info('------------------------------');

        $this->newLine();


        if ($freshSetup) {

            // Run migrate:fresh

            $this->call('migrate:fresh', [

                '--force' => true,

                '--no-interaction' => true

            ]);

        } else {

            // Run normal migration

            $this->call('migrate', [

                '--force' => true,

                '--no-interaction' => true

            ]);

        }


        $this->newLine();

        $this->info('âœ… Database migrations completed.');

        $this->newLine();


        // ===================================

        // ğŸ‘¤ CREATE USERS (MUST BE BEFORE SEEDERS)

        // ===================================

        $this->info('------------------------------');

        $this->info('ğŸ‘¤ Creating users...');

        $this->info('------------------------------');

        $this->newLine();


        $this->createUser();


        $this->newLine();

        $this->info('âœ… Users created successfully.');

        $this->newLine();


        // ===================================

        // ğŸ“Š ENSURING VISITOR_LOGS TABLE

        // ===================================

        if ($freshSetup) {

            $this->info('------------------------------');

            $this->info('ğŸ“Š Ensuring visitor_logs table...');

            $this->info('------------------------------');

            $this->newLine();


            if (!\Illuminate\Support\Facades\Schema::hasTable('visitor_logs')) {

                $this->warn('âš ï¸  visitor_logs table missing after migrate:fresh');


                try {

                    $this->call('migrate', [

                        '--path' => 'database/migrations/2025_12_09_204103_create_visitor_logs_table.php',

                        '--force' => true,

                        '--no-interaction' => true

                    ]);

                    $this->info('âœ… Visitor logs table migrated.');

                } catch (\Exception $e) {

                    $this->error('âŒ Failed to create visitor_logs table: ' . $e->getMessage());

                    $this->info('Creating table directly as fallback...');


                    \Illuminate\Support\Facades\Schema::create('visitor_logs', function ($table) {

                        $table->id();

                        $table->string('user_id')->nullable();

                        $table->string('username')->nullable();

                        $table->string('ip_address')->nullable();

                        $table->text('user_agent')->nullable();

                        $table->string('page_url')->nullable();

                        $table->timestamp('connected_at');

                        $table->timestamp('disconnected_at')->nullable();

                        $table->timestamps();

                    });

                    $this->info('âœ… visitor_logs table created directly.');

                }

            } else {

                $count = \App\Models\VisitorLog::count();

                $this->info("âœ… visitor_logs table exists with {$count} records.");

            }


            $this->newLine();

        }


        // ===================================

        // ğŸ­ SEED JOKE CATEGORIES (FIRST)

        // ===================================

        if ($freshSetup) {

            $this->info('------------------------------');

            $this->info('ğŸ­ Seeding joke categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('JokecatSeeder');


            $this->newLine();

            $this->info('âœ… Joke categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ˜‚ IMPORTING JOKES (WITH PROGRESS)

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ˜‚ Importing jokes from SQL file...');

            $this->info('------------------------------');

            $this->newLine();


            $this->warn('â³ This may take a moment for large SQL files...');

            $this->newLine();


            $this->safeSeeder('JokesTableSeeder');


            $this->newLine();

            $this->info('âœ… Jokes imported successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“š SEED BLOG POSTS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“š Seeding blog posts...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('BlogPostSeeder');


            $this->newLine();

            $this->info('âœ… Blog posts seeded successfully.');


            // SITE SETTINGS SEEDER
            $this->info('------------------------------');
            $this->info('âš™ï¸ Seeding site settings...');
            $this->info('------------------------------');
            $this->newLine();
            $this->safeSeeder('SiteSettingSeeder');
            $this->newLine();
            $this->info('âœ… Site settings seeded successfully.');
            $this->newLine();

            $this->newLine();


            // ===================================

            // ğŸ“¦ SEED SHOP CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“¦ Seeding shop categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('ShopCategorySeeder');


            $this->newLine();

            $this->info('âœ… Shop categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ›ï¸ SEED SHOP PRODUCTS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ›ï¸ Seeding shop products...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('ShopProductSeeder');


            $this->newLine();

            $this->info('âœ… Shop products seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“¹ SEED VIDEO CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“¹ Seeding video categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('VideosCategorySeeder');


            $this->newLine();

            $this->info('âœ… Video categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ¥ SEED VIDEOS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ¥ Seeding videos...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('VideosSeeder');


            $this->newLine();

            $this->info('âœ… Videos seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“± SEED CHANNEL CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“± Seeding channel categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('ChannelCategorySeeder');


            $this->newLine();

            $this->info('âœ… Channel categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“º SEED CHANNELS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“º Seeding channels...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('ChannelSeeder');


            $this->newLine();

            $this->info('âœ… Channels seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“ SEED BLOG CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“ Seeding blog categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('BlogcatSeeder');


            $this->newLine();

            $this->info('âœ… Blog categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ–¼ï¸ SEED GALLERY CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ–¼ï¸ Seeding gallery categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('GallerycatSeeder');


            $this->newLine();

            $this->info('âœ… Gallery categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“· SEED GALLERY ITEMS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“· Seeding gallery items...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('GallerySeeder');


            $this->newLine();

            $this->info('âœ… Gallery items seeded successfully.');

            $this->newLine();


            // ===================================

            // â­ SEED FAVOURITES

            // ===================================

            $this->info('------------------------------');

            $this->info('â­ Seeding favourites...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('FavouritesSeeder');


            $this->newLine();

            $this->info('âœ… Favourites seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ·ï¸ SEED TAG CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ·ï¸ Seeding tag categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('TagcatSeeder');


            $this->newLine();

            $this->info('âœ… Tag categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ¯ SEED TAGS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ¯ Seeding tags...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('TagsSeeder');


            $this->newLine();

            $this->info('âœ… Tags seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ”— SEED LINK CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ”— Seeding link categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('LinkcatSeeder');


            $this->newLine();

            $this->info('âœ… Link categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸŒ SEED LINKS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸŒ Seeding links...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('LinksSeeder');


            $this->newLine();

            $this->info('âœ… Links seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ’¬ SEED LIVECHAT MESSAGES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ’¬ Seeding LiveChat messages...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('LivechatSeeder');


            $this->newLine();

            $this->info('âœ… LiveChat messages seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ’¡ SEED QUOTES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ’¡ Seeding quotes...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('QuoteSeeder');


            $this->newLine();

            $this->info('âœ… Quotes seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸµ SEED MUSIC CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸµ Seeding music categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('MusicsSeeder');


            $this->newLine();

            $this->info('âœ… Music categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ¼ SEED MUSIC ITEMS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ¼ Seeding music items...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('MusicSeeder');


            $this->newLine();

            $this->info('âœ… Music items seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“„ SEED PAGE CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“„ Seeding page categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('PagesCategorySeeder');


            $this->newLine();

            $this->info('âœ… Page categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“ƒ SEED PAGES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“ƒ Seeding pages...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('PageSeeder');


            $this->newLine();

            $this->info('âœ… Pages seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“° SEED NEWS CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“° Seeding news categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('NewsCategorySeeder');


            $this->newLine();

            $this->info('âœ… News categories seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“¢ SEED NEWS ITEMS

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“¢ Seeding news items...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('NewsSeeder');


            $this->newLine();

            $this->info('âœ… News items seeded successfully.');

            $this->newLine();


            // ===================================

            // ğŸ“‹ SEED DOWNLOAD CATEGORIES

            // ===================================

            $this->info('------------------------------');

            $this->info('ğŸ“‹ Seeding download categories...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('DownloadCategorySeeder');


            $this->newLine();

            $this->info('âœ… Download categories seeded successfully.');

            $this->newLine();


            // ===================================

            // â¬‡ï¸ SEED DOWNLOADS

            // ===================================

            $this->info('------------------------------');

            $this->info('â¬‡ï¸ Seeding downloads...');

            $this->info('------------------------------');

            $this->newLine();


            $this->safeSeeder('DownloadSeeder');


            $this->newLine();

            $this->info('âœ… Downloads seeded successfully.');

            $this->newLine();

        }


        // ===================================

        // ğŸ”— CREATE SYMBOLIC LINK

        // ===================================

        $this->info('------------------------------');

        $this->info('ğŸ”— Creating storage symlink...');

        $this->info('------------------------------');

        $this->newLine();


        $storageLinkExists = is_link(public_path('storage'));


        if ($storageLinkExists) {

            $this->info('â„¹ï¸  Storage symlink already exists and is in place.');

        } else {

            Artisan::call('storage:link', ['--force' => true, '--no-interaction' => true]);

            $this->info('âœ… Storage symlink has been created successfully.');

            $storageLinkExists = true;

        }

        $this->newLine();


        // Initialize counts

        $documentCount = 0;

        $imageCount = 0;


        // ===================================

        // ğŸ“ REBUILD DOCUMENTS (CONDITIONAL)

        // ===================================

        if ($rebuildDocs) {

            $this->info('------------------------------');

            $this->info('ğŸ“„ Rebuilding documents...');

            $this->info('------------------------------');

            $this->newLine();


            $documentCount = $this->rebuildDocuments();


            $this->newLine();

            $this->info('âœ… Documents rebuild complete. Total in database: ' . $documentCount);

            $this->newLine();

        } else {

            $this->info('------------------------------');

            $this->info('ğŸ“„ Documents...');

            $this->info('------------------------------');

            $this->newLine();

            $this->warn('â­ï¸  Skipping documents rebuild (user choice)');

            $documentCount = Document::count();

            $this->info("   Existing records in database: {$documentCount}");

            $this->newLine();

        }


        // ===================================

        // ğŸ–¼ï¸ REBUILD IMAGES (CONDITIONAL)

        // ===================================

        if ($rebuildImages) {

            $this->info('------------------------------');

            $this->info('ğŸ–¼ï¸  Rebuilding images...');

            $this->info('------------------------------');

            $this->newLine();


            $imageCount = $this->rebuildImages();


            $this->newLine();

            $this->info('âœ… Images rebuild complete. Total in database: ' . $imageCount);

            $this->newLine();

        } else {

            $this->info('------------------------------');

            $this->info('ğŸ–¼ï¸  Images...');

            $this->info('------------------------------');

            $this->newLine();

            $this->warn('â­ï¸  Skipping images rebuild (user choice)');

            $imageCount = Image::count();

            $this->info("   Existing records in database: {$imageCount}");

            $this->newLine();

        }


        // ===================================

        // ğŸ”’ SYNC PROTECTED STORAGE (CONDITIONAL)

        // ===================================

        $protectedFileStats = ['files' => 0, 'folders' => 0, 'total' => 0];


        if ($rebuildProtected && !$this->option('skip-protected')) {

            $this->info('------------------------------');

            $this->info('ğŸ”’ Syncing protected storage files...');

            $this->info('------------------------------');

            $this->newLine();


            $this->warn('â³ This may take several minutes for large directories...');

            $this->newLine();


            $protectedFileStats = $this->syncProtectedStorage();


            $this->newLine();

            $this->info('âœ… Protected storage sync complete.');

            $this->info('   Files: ' . $protectedFileStats['files']);

            $this->info('   Folders: ' . $protectedFileStats['folders']);

            $this->info('   Total: ' . $protectedFileStats['total']);

            $this->newLine();

        } else {

            $this->info('------------------------------');

            $this->info('ğŸ”’ Protected storage...');

            $this->info('------------------------------');

            $this->newLine();

            $this->warn('â­ï¸  Skipping protected storage sync (user choice)');


            $existingFiles = ProtectedFile::where('type', 'file')->count();

            $existingFolders = ProtectedFile::where('type', 'folder')->count();

            $existingTotal = ProtectedFile::count();


            $protectedFileStats = [

                'files' => $existingFiles,

                'folders' => $existingFolders,

                'total' => $existingTotal

            ];


            $this->info("   Existing records in database: {$existingTotal} ({$existingFiles} files, {$existingFolders} folders)");

            $this->newLine();

        }


        // ===================================
        // ğŸ¸ SYNC GUITAR SCORES STORAGE
        // ===================================
        $guitarScoreStats = ['files' => 0, 'folders' => 0, 'total' => 0];

        if ($rebuildGuitarScores && !$this->option('skip-guitar')) {
            $this->info('------------------------------');
            $this->info('ğŸ¸ Syncing guitar scores...');
            $this->info('------------------------------');
            $this->newLine();

            $this->warn('â³ This may take several minutes...');
            $this->newLine();

            $guitarScoreStats = $this->syncGuitarScores();

            $this->newLine();
            $this->info('âœ… Guitar scores sync complete.');
            $this->info('   Files: ' . $guitarScoreStats['files']);
            $this->info('   Folders: ' . $guitarScoreStats['folders']);
            $this->info('   Total: ' . $guitarScoreStats['total']);
            $this->newLine();
        } else {
            $this->info('------------------------------');
            $this->info('ğŸ¸ Guitar scores...');
            $this->info('------------------------------');
            $this->newLine();
            $this->warn('â­ï¸  Skipping guitar scores sync (user choice)');

            $existingFiles = GuitarScore::where('type', 'file')->count();
            $existingFolders = GuitarScore::where('type', 'folder')->count();
            $existingTotal = GuitarScore::count();

            $guitarScoreStats = [
                'files' => $existingFiles,
                'folders' => $existingFolders,
                'total' => $existingTotal
            ];

            $this->info("   Existing records in database: {$existingTotal} ({$existingFiles} files, {$existingFolders} folders)");
            $this->newLine();
        }


        // ===================================

        // ğŸ”§ SYSTEM MAINTENANCE (AUTOMATIC)

        // ===================================

        $this->info('------------------------------');

        $this->info('ğŸ”§ Running system maintenance...');

        $this->info('------------------------------');

        $this->newLine();


        $this->call('system:maintenance', ['--no-interaction' => true]);


        $this->newLine();

        $this->info('âœ… System maintenance complete.');

        $this->newLine();


        // ===================================

        // ğŸ“Š FINAL RESULTS

        // ===================================

        $this->newLine();

        $this->info('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');

        $this->info('â•‘            SETUP COMPLETED SUCCESSFULLY          â•‘');

        $this->info('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        $this->newLine();

        $this->info('ğŸ“Š Summary:');


        // Get Blog Posts count

        $blogpostsCount = \App\Models\BlogPost::count();


        // Get joke counts

        $jokeCategoryCount = \App\Models\Jokecat::count();

        $jokeCount = \App\Models\Joke::count();


        $setupMode = $freshSetup ? 'âœ… Fresh Setup' : 'âš ï¸  Partial Rebuild';

        $storageLinkStatus = $storageLinkExists ? 'âœ… Verified' : 'âš ï¸  Not created';


        $documentStatus = $rebuildDocs

            ? ($documentCount > 0 ? "âœ… {$documentCount} rebuilt" : 'âš ï¸  None found')

            : "â­ï¸  Skipped ({$documentCount} existing)";


        $imageStatus = $rebuildImages

            ? ($imageCount > 0 ? "âœ… {$imageCount} rebuilt" : 'âš ï¸  None found')

            : "â­ï¸  Skipped ({$imageCount} existing)";


        $protectedStorageStatus = $rebuildProtected

            ? ($protectedFileStats['total'] > 0 ? "âœ… {$protectedFileStats['files']} files, {$protectedFileStats['folders']} folders" : 'âš ï¸  Empty')

            : "â­ï¸  Skipped ({$protectedFileStats['total']} existing)";

        $guitarScoresStatus = $rebuildGuitarScores

            ? ($guitarScoreStats['total'] > 0 ? "âœ… {$guitarScoreStats['files']} files, {$guitarScoreStats['folders']} folders" : 'âš ï¸  Empty')

            : "â­ï¸  Skipped ({$guitarScoreStats['total']} existing)";


        $blogpostStatus = $blogpostsCount > 0 ? "âœ… {$blogpostsCount} processed" : 'âš ï¸  None found';

        $jokeCategoryStatus = $jokeCategoryCount > 0 ? "âœ… {$jokeCategoryCount} categories" : 'âš ï¸  None found';

        $jokeStatus = $jokeCount > 0 ? "âœ… {$jokeCount} jokes" : 'âš ï¸  None found';


        // Get visitor logs status

        $visitorLogsExists = \Illuminate\Support\Facades\Schema::hasTable('visitor_logs');

        $visitorLogsCount = $visitorLogsExists ? \App\Models\VisitorLog::count() : 0;

        $visitorLogsStatus = $visitorLogsExists ?

            ($visitorLogsCount > 0 ? "âœ… {$visitorLogsCount} records" : "âœ… Table ready") :

            'âŒ Missing';


        $this->table(

            ['Task', 'Status'],

            [

                ['Setup Mode', $setupMode],

                ['Application Key', 'âœ… Generated'],

                ['Database Migration', 'âœ… Completed'],

                ['Joke Categories', $jokeCategoryStatus],

                ['Blog Posts', $blogpostStatus],

                ['Jokes Imported', $jokeStatus],

                ['Users Created', $freshSetup ? 'âœ… 3 Users (Mark, Jo, Jane)' : 'â­ï¸  Skipped (existing)'],

                ['Storage Link', $storageLinkStatus],

                ['Documents', $documentStatus],

                ['Images', $imageStatus],

                ['Protected Storage', $protectedStorageStatus],

                ['Guitar Scores', $guitarScoresStatus],

                ['Visitor Logs', $visitorLogsStatus],

                ['System Maintenance', 'âœ… Completed'],

            ]

        );

        $this->newLine();

        $this->info('ğŸ‰ Your system is ready to use!');

        $this->info('ğŸ” Login with: ' . self::ADMIN_EMAIL);


        return Command::SUCCESS;

    }


    /**
     * Sync protected storage files with database (with batching to prevent hangs)
     */

    private function syncProtectedStorage()

    {

        try {

            $this->info('ğŸ” Starting protected storage sync...');


            // Check if protected storage directory exists

            $protectedPath = storage_path('app/protected');

            $this->info("ğŸ“ Checking path: {$protectedPath}");


            if (!is_dir($protectedPath)) {

                $this->warn('âš ï¸  Protected storage directory does not exist. Creating it...');

                FileFacade::makeDirectory($protectedPath, 0755, true);

                $this->info("âœ… Created directory: {$protectedPath}");


                return [

                    'files' => 0,

                    'folders' => 0,

                    'total' => 0,

                ];

            }


            $this->info("âœ… Directory exists: {$protectedPath}");


            // Clear existing records for fresh sync

            $existingCount = ProtectedFile::count();

            if ($existingCount > 0) {

                ProtectedFile::truncate();

                $this->info("ğŸ—‘ï¸  Cleared {$existingCount} existing protected files records.");

            }


            // Check if 'protected' disk is configured

            try {

                $disk = Storage::disk('protected');

                $this->info('âœ… Protected disk configured');

            } catch (\Exception $e) {

                $this->error('âŒ Protected disk not configured: ' . $e->getMessage());

                return [

                    'files' => 0,

                    'folders' => 0,

                    'total' => 0,

                ];

            }


            // Get all files and directories recursively

            $this->info('ğŸ” Scanning for files and directories...');


            $allFiles = $disk->allFiles();

            $allDirectories = $disk->allDirectories();


            $this->info("ğŸ“Š Storage scan results:");

            $this->info("   Files found: " . count($allFiles));

            $this->info("   Directories found: " . count($allDirectories));


            if (count($allFiles) === 0 && count($allDirectories) === 0) {

                $this->warn('âš ï¸  No files or folders found in protected storage.');

                return [

                    'files' => 0,

                    'folders' => 0,

                    'total' => 0,

                ];

            }


            $totalItems = count($allDirectories) + count($allFiles);

            $this->info("ğŸ“¦ Total items to process: {$totalItems}");

            $this->newLine();


            $processedDirs = 0;

            $processedFiles = 0;

            $errors = [];


            // Process directories in batches

            $this->info('ğŸ“ Processing directories...');

            $dirBatchSize = 50;

            $dirBatches = array_chunk($allDirectories, $dirBatchSize);


            foreach ($dirBatches as $batchIndex => $dirBatch) {

                $batchNum = $batchIndex + 1;

                $totalBatches = count($dirBatches);

                $this->info("   Batch {$batchNum}/{$totalBatches} (directories)...");


                foreach ($dirBatch as $directory) {

                    try {

                        $this->syncDirectory($directory, $disk);

                        $processedDirs++;

                    } catch (\Exception $e) {

                        $errors[] = "Directory {$directory}: " . $e->getMessage();

                    }

                }


                // Show progress

                $percent = round(($processedDirs / count($allDirectories)) * 100);

                $this->info("   Progress: {$processedDirs}/" . count($allDirectories) . " directories ({$percent}%)");

            }


            $this->newLine();

            $this->info('ğŸ“„ Processing files...');


            // Process files in batches

            $fileBatchSize = 100;

            $fileBatches = array_chunk($allFiles, $fileBatchSize);


            foreach ($fileBatches as $batchIndex => $fileBatch) {

                $batchNum = $batchIndex + 1;

                $totalBatches = count($fileBatches);

                $this->info("   Batch {$batchNum}/{$totalBatches} (files)...");


                foreach ($fileBatch as $file) {

                    try {

                        $this->syncFile($file, $disk);

                        $processedFiles++;

                    } catch (\Exception $e) {

                        $errors[] = "File {$file}: " . $e->getMessage();

                    }

                }


                // Show progress

                $percent = round(($processedFiles / count($allFiles)) * 100);

                $this->info("   Progress: {$processedFiles}/" . count($allFiles) . " files ({$percent}%)");

            }


            $this->newLine();


            // Show any errors

            if (count($errors) > 0) {

                $this->warn('âš ï¸  Some items had errors:');

                foreach (array_slice($errors, 0, 10) as $error) {

                    $this->warn("   {$error}");

                }

                if (count($errors) > 10) {

                    $this->warn("   ... and " . (count($errors) - 10) . " more errors");

                }

            }


            // Get final counts from database

            $fileCount = ProtectedFile::where('type', 'file')->count();

            $folderCount = ProtectedFile::where('type', 'folder')->count();

            $totalCount = ProtectedFile::count();


            $this->info("âœ… Sync summary:");

            $this->info("   Directories processed: {$processedDirs}");

            $this->info("   Files processed: {$processedFiles}");

            $this->info("   Total in database: {$totalCount}");


            return [

                'files' => $fileCount,

                'folders' => $folderCount,

                'total' => $totalCount,

            ];


        } catch (\Exception $e) {

            $this->error('âŒ Failed to sync protected storage: ' . $e->getMessage());

            $this->error('Stack trace: ' . $e->getTraceAsString());


            return [

                'files' => 0,

                'folders' => 0,

                'total' => 0,

            ];

        }

    }


    /**
     * Sync a directory to the database
     */

    private function syncDirectory($path, $disk)

    {

        $name = basename($path);

        $parentPath = dirname($path);

        if ($parentPath === '.') {

            $parentPath = null;

        }


        $resource = explode('/', $path)[0] ?? null;


        ProtectedFile::create([

            'name' => $name,

            'path' => $path,

            'parent_path' => $parentPath,

            'type' => 'folder',

            'resource' => $resource,

            'file_modified_at' => now(),

        ]);

    }


    /**
     * Sync a file to the database
     */

    private function syncFile($path, $disk)

    {

        $name = basename($path);

        $parentPath = dirname($path);

        if ($parentPath === '.') {

            $parentPath = null;

        }


        $extension = strtolower(pathinfo($name, PATHINFO_EXTENSION));

        $size = $disk->size($path);

        $resource = explode('/', $path)[0] ?? null;


        $mimeTypes = ProtectedFile::mimeTypes();

        $mimeType = $mimeTypes[$extension] ?? 'application/octet-stream';


        ProtectedFile::create([

            'name' => $name,

            'path' => $path,

            'parent_path' => $parentPath,

            'type' => 'file',

            'extension' => $extension,

            'mime_type' => $mimeType,

            'size' => $size,

            'resource' => $resource,

            'file_modified_at' => \Carbon\Carbon::createFromTimestamp($disk->lastModified($path)),

        ]);

    }


    /**
     * Rebuild documents from storage folder
     */

    private function rebuildDocuments()

    {
        $folder = storage_path('app/public/assets');

        if (!is_dir($folder)) {
            FileFacade::makeDirectory($folder, 0755, true);
            $this->info("Folder created: {$folder}");
        }

        $filesInFolder = array_filter(scandir($folder), fn($f) => !in_array($f, ['.', '..']) && is_file($folder . DIRECTORY_SEPARATOR . $f));

        if (empty($filesInFolder)) {
            $this->warn('Warning: The assets folder is empty. No documents to rebuild.');
            return 0;
        }

        Document::truncate();
        $this->warn('Documents table cleared.');
        $this->newLine();

        // BATCH PROCESSING for performance
        $batchSize = 100;
        $fileBatches = array_chunk($filesInFolder, $batchSize);
        $countAdded = 0;
        $totalFiles = count($filesInFolder);

        $this->info("ğŸ“„ Processing {$totalFiles} documents in batches...");
        $this->newLine();

        foreach ($fileBatches as $batchIndex => $fileBatch) {
            $batchNum = $batchIndex + 1;
            $totalBatches = count($fileBatches);
            $percent = round(($batchNum / $totalBatches) * 100);
            $this->info("   Batch {$batchNum}/{$totalBatches} ({$percent}%)...");

            foreach ($fileBatch as $file) {
                $shortName = substr(
                    preg_replace('/[\(\[].*?[\)\]]/', '', str_replace(' ', '', $file)),
                    0,
                    30
                );

                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));

                Document::create([
                    'name' => $file,
                    'shortname' => $shortName,
                    'path' => 'assets/' . $file,
                    'description' => $shortName,
                    'extension' => $ext,
                ]);

                $countAdded++;
            }
        }

        $this->newLine();
        $this->info("âœ… Total documents added: {$countAdded}");

        return $countAdded;
    }

    private function rebuildImages()

    {
        $folder = storage_path('app/public/images');

        if (!is_dir($folder)) {
            FileFacade::makeDirectory($folder, 0755, true);
            $this->info("Folder created: {$folder}");
        }

        $filesInFolder = array_filter(scandir($folder), fn($f) => !in_array($f, ['.', '..']) && is_file($folder . DIRECTORY_SEPARATOR . $f));

        if (empty($filesInFolder)) {
            $this->warn('Warning: The images folder is empty. No images to rebuild.');
            return 0;
        }

        Image::truncate();
        $this->warn('Images table cleared.');
        $this->newLine();

        // BATCH PROCESSING for performance
        $batchSize = 100;
        $fileBatches = array_chunk($filesInFolder, $batchSize);
        $countAdded = 0;
        $totalFiles = count($filesInFolder);

        $this->info("ğŸ–¼ï¸ Processing {$totalFiles} images in batches...");
        $this->newLine();

        foreach ($fileBatches as $batchIndex => $fileBatch) {
            $batchNum = $batchIndex + 1;
            $totalBatches = count($fileBatches);
            $percent = round(($batchNum / $totalBatches) * 100);
            $this->info("   Batch {$batchNum}/{$totalBatches} ({$percent}%)...");

            foreach ($fileBatch as $file) {
                $shortName = substr(
                    preg_replace('/[\(\[].*?[\)\]]/', '', str_replace(' ', '', $file)),
                    0,
                    255
                );

                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));

                Image::create([
                    'name' => $file,
                    'shortname' => $shortName,
                    'path' => 'images/' . $file,
                    'description' => $shortName,
                    'extension' => $ext,
                ]);

                $countAdded++;
            }
        }

        $this->newLine();
        $this->info("âœ… Total images added: {$countAdded}");

        return $countAdded;
    }

    private function createUser()

    {

        try {

            // ===================================

            // ğŸ”‘ SEED PERMISSIONS FIRST

            // ===================================

            $this->info('ğŸ”‘ Seeding permissions...');

            $this->safeSeeder('PermissionSeeder');

            $this->info('âœ… Permissions seeded.');

            $this->newLine();


            // ===================================

            // ğŸ­ SETUP ROLES WITH PERMISSIONS

            // ===================================

            $this->info('ğŸ­ Setting up roles...');


            // Super Admin gets ALL permissions

            $superAdminRole = \Spatie\Permission\Models\Role::firstOrCreate(['name' => 'Super Admin']);

            $superAdminRole->syncPermissions(\Spatie\Permission\Models\Permission::all());


            // LiveChat gets ONLY "live chat" permission

            $liveChatRole = \Spatie\Permission\Models\Role::firstOrCreate(['name' => 'LiveChat']);

            $liveChatPermission = \Spatie\Permission\Models\Permission::where('name', 'live chat')->first();

            if ($liveChatPermission) {

                $liveChatRole->syncPermissions([$liveChatPermission]);

            }


            $this->info('âœ… Roles configured.');

            $this->newLine();


            // ===================================

            // ğŸ‘¤ CREATE USERS

            // ===================================

            $avatarToUse = self::ADMIN_AVATAR;


            // CREATE MARK (Super Admin)

            $mark = User::updateOrCreate(
                ['email' => self::ADMIN_EMAIL],
                [
                    'name' => self::ADMIN_NAME,
                    'password' => bcrypt(self::ADMIN_PASSWORD),
                    'avatar' => $avatarToUse,
                    'locale' => 'en',
                    'email_verified_at' => now(),
                ]
            );


            // CREATE JO (LiveChat)

            $jo = User::updateOrCreate(
                ['email' => 'jo@jo.co.za'],
                [
                    'name' => 'Jo',
                    'password' => bcrypt('password123'),
                    'avatar' => 'blogpostnewavatar_no-img-avatar.jpg',
                    'locale' => 'en',
                    'email_verified_at' => now(),
                ]
            );


            // CREATE JANE (Regular user)

            $jane = User::updateOrCreate(
                ['email' => 'jane@jane.co.za'],
                [
                    'name' => 'Jane',
                    'password' => bcrypt('password123'),
                    'avatar' => 'blogpostnewavatar_no-img-avatar.jpg',
                    'locale' => 'en',
                    'email_verified_at' => now(),
                ]
            );


            // ===================================

            // ğŸ­ ASSIGN ROLES TO USERS

            // ===================================

            $mark->assignRole($superAdminRole);

            $jo->assignRole($liveChatRole);

            // jane gets no role


            $this->info('âœ… Users created and roles assigned.');

            $this->newLine();


            // ===================================

            // ğŸ“Š DISPLAY RESULTS

            // ===================================

            $users = [

                [

                    $mark->id,

                    $mark->name,

                    $mark->email,

                    $mark->roles->pluck('name')->join(', '),

                    $mark->getAllPermissions()->count() . ' perms',

                    $mark->avatar,

                ],

                [

                    $jo->id,

                    $jo->name,

                    $jo->email,

                    $jo->roles->pluck('name')->join(', '),

                    $jo->getAllPermissions()->count() . ' perms',

                    $jo->avatar,

                ],

                [

                    $jane->id,

                    $jane->name,

                    $jane->email,

                    $jane->roles->pluck('name')->join(', ') ?: 'No role',

                    $jane->getAllPermissions()->count() . ' perms',

                    $jane->avatar,

                ],

            ];


            $this->table(

                ['ID', 'Name', 'Email', 'Roles', 'Permissions', 'Avatar'],

                $users

            );


            $this->newLine();


        } catch (\Exception $e) {

            $this->error('âŒ Failed to create users: ' . $e->getMessage());

            $this->error('Stack trace: ' . $e->getTraceAsString());

        }

    }


    /**
     * Safely run a seeder - skip if it doesn't exist
     */

    private function safeSeeder($seederClass, $description = null)

    {

        $description = $description ?? $seederClass;


        try {

            // Check if the seeder class exists

            $fullClassName = "Database\\Seeders\\{$seederClass}";

            if (!class_exists($fullClassName)) {

                $this->warn("âš ï¸  Seeder not found: {$seederClass} - skipping");

                return false;

            }


            $this->call('db:seed', ['--class' => $seederClass, '--force' => true]);

            return true;

        } catch (\Exception $e) {

            $this->error("âŒ Failed to run {$seederClass}: " . $e->getMessage());

            $this->warn("Continuing with next seeder...");

            return false;

        }
    }


    /**
     * Sync Guitar Scores Storage
     */
    private function syncGuitarScores()
    {
        try {
            $this->info('ğŸ” Starting guitar scores sync...');

            // Check if guitar scores directory exists
            $guitarPath = storage_path('app/protectedGuitar');
            $this->info("ğŸ“ Checking path: {$guitarPath}");

            if (!is_dir($guitarPath)) {
                $this->warn('âš ï¸  Guitar scores directory does not exist. Creating it...');
                FileFacade::makeDirectory($guitarPath, 0755, true);
                $this->info("âœ… Created directory: {$guitarPath}");

                return [
                    'files' => 0,
                    'folders' => 0,
                    'total' => 0,
                ];
            }

            $this->info("âœ… Directory exists: {$guitarPath}");

            // Clear existing records for fresh sync
            $existingCount = GuitarScore::count();
            if ($existingCount > 0) {
                GuitarScore::truncate();
                $this->info("ğŸ—‘ï¸  Cleared {$existingCount} existing guitar score records.");
            }

            // Check if 'protectedGuitar' disk is configured
            try {
                $disk = Storage::disk('protectedGuitar');
                $this->info('âœ… ProtectedGuitar disk configured');
            } catch (\Exception $e) {
                $this->error('âŒ ProtectedGuitar disk not configured: ' . $e->getMessage());
                return [
                    'files' => 0,
                    'folders' => 0,
                    'total' => 0,
                ];
            }

            // Get all files and directories recursively
            $this->info('ğŸ” Scanning for files and directories...');

            $allFiles = $disk->allFiles();
            $allDirectories = $disk->allDirectories();

            $this->info("ğŸ“Š Guitar scores scan results:");
            $this->info("   Files found: " . count($allFiles));
            $this->info("   Directories found: " . count($allDirectories));

            if (count($allFiles) === 0 && count($allDirectories) === 0) {
                $this->warn('âš ï¸  No files or folders found in guitar scores directory.');
                return [
                    'files' => 0,
                    'folders' => 0,
                    'total' => 0,
                ];
            }

            $totalItems = count($allDirectories) + count($allFiles);
            $this->info("ğŸ“¦ Total items to process: {$totalItems}");
            $this->newLine();

            $processedDirs = 0;
            $processedFiles = 0;
            $errors = [];

            // Process directories in batches
            $this->info('ğŸ“ Processing directories...');
            $dirBatchSize = 50;
            $dirBatches = array_chunk($allDirectories, $dirBatchSize);

            foreach ($dirBatches as $batchIndex => $dirBatch) {
                $batchNum = $batchIndex + 1;
                $totalBatches = count($dirBatches);
                $this->info("   Batch {$batchNum}/{$totalBatches} (directories)...");

                foreach ($dirBatch as $directory) {
                    try {
                        $this->syncGuitarDirectory($directory, $disk);
                        $processedDirs++;
                    } catch (\Exception $e) {
                        $errors[] = "Directory {$directory}: " . $e->getMessage();
                    }
                }

                // Show progress
                $percent = round(($processedDirs / count($allDirectories)) * 100);
                $this->info("   Progress: {$processedDirs}/" . count($allDirectories) . " directories ({$percent}%)");
            }

            $this->newLine();
            $this->info('ğŸ“„ Processing files...');

            // Process files in batches
            $fileBatchSize = 100;
            $fileBatches = array_chunk($allFiles, $fileBatchSize);

            foreach ($fileBatches as $batchIndex => $fileBatch) {
                $batchNum = $batchIndex + 1;
                $totalBatches = count($fileBatches);
                $this->info("   Batch {$batchNum}/{$totalBatches} (files)...");

                foreach ($fileBatch as $file) {
                    try {
                        $this->syncGuitarFile($file, $disk);
                        $processedFiles++;
                    } catch (\Exception $e) {
                        $errors[] = "File {$file}: " . $e->getMessage();
                    }
                }

                // Show progress
                $percent = round(($processedFiles / count($allFiles)) * 100);
                $this->info("   Progress: {$processedFiles}/" . count($allFiles) . " files ({$percent}%)");
            }

            $this->newLine();

            // Show any errors
            if (count($errors) > 0) {
                $this->warn('âš ï¸  Some items had errors:');
                foreach (array_slice($errors, 0, 10) as $error) {
                    $this->warn("   {$error}");
                }
                if (count($errors) > 10) {
                    $this->warn("   ... and " . (count($errors) - 10) . " more errors");
                }
            }

            // Get final counts from database
            $fileCount = GuitarScore::where('type', 'file')->count();
            $folderCount = GuitarScore::where('type', 'folder')->count();
            $totalCount = GuitarScore::count();

            $this->info("âœ… Sync summary:");
            $this->info("   Directories processed: {$processedDirs}");
            $this->info("   Files processed: {$processedFiles}");
            $this->info("   Total in database: {$totalCount}");

            return [
                'files' => $fileCount,
                'folders' => $folderCount,
                'total' => $totalCount,
            ];

        } catch (\Exception $e) {
            $this->error('âŒ Failed to sync guitar scores: ' . $e->getMessage());
            $this->error('Stack trace: ' . $e->getTraceAsString());

            return [
                'files' => 0,
                'folders' => 0,
                'total' => 0,
            ];
        }
    }

    /**
     * Sync a guitar directory to the database
     */
    private function syncGuitarDirectory($path, $disk)
    {
        $name = basename($path);
        $parentPath = dirname($path);

        // Set parent_path to null only for root-level directories
        if ($parentPath === '.' || $parentPath === '' || $parentPath === $path) {
            $parentPath = null;
        }

        // Use DB::table() to bypass mass assignment protection
        DB::table('guitar_scores')->insert([
            'name' => $name,
            'path' => $path,
            'parent_path' => $parentPath,
            'type' => 'folder',
            'extension' => null,
            'mime_type' => null,
            'size' => null,
            'file_modified_at' => now(),
            'created_at' => now(),
            'updated_at' => now(),
        ]);
    }

    /**
     * Sync a guitar file to the database
     */
    private function syncGuitarFile($path, $disk)
    {
        $name = basename($path);
        $parentPath = dirname($path);

        // Set parent_path to null only for root-level files
        if ($parentPath === '.' || $parentPath === '' || $parentPath === $path) {
            $parentPath = null;
        }

        $extension = strtolower(pathinfo($name, PATHINFO_EXTENSION));

        // Skip non-relevant file types
        if (!in_array($extension, ['mp3', 'mp4', 'pdf', 'jpg', 'jpeg', 'png', 'gif', 'gp'])) {
            return;
        }

        $size = $disk->size($path);

        $mimeTypes = [
            'mp3' => 'audio/mpeg',
            'mp4' => 'video/mp4',
            'pdf' => 'application/pdf',
            'jpg' => 'image/jpeg',
            'jpeg' => 'image/jpeg',
            'png' => 'image/png',
            'gif' => 'image/gif',
            'gp' => 'application/octet-stream',
        ];

        $mimeType = $mimeTypes[$extension] ?? 'application/octet-stream';

        // Use DB::table() to bypass mass assignment protection
        DB::table('guitar_scores')->insert([
            'name' => $name,
            'path' => $path,
            'parent_path' => $parentPath,  // â† This will NOW be saved!
            'type' => 'file',
            'extension' => $extension,
            'mime_type' => $mimeType,
            'size' => $size,
            'file_modified_at' => \Carbon\Carbon::createFromTimestamp($disk->lastModified($path)),
            'created_at' => now(),
            'updated_at' => now(),
        ]);
    }
}