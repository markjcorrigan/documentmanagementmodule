{% set editor_id = id|default('editor') %}
{% set editor_name = name|default('content') %}

<h2>Project Notes Editor</h2>

{% if session('success') %}
    <p style="color:green">{{ session('success') }}</p>
{% endif %}
{% if session('error') %}
    <p style="color:red">{{ session('error') }}</p>
{% endif %}

<form action="{{ route('editor.save') }}" method="POST">
    {{ csrf_field() }}

    <label for="custom_name">Filename prefix (max 10 chars):</label>
    <input type="text" id="custom_name" name="custom_name" maxlength="10"
           placeholder="e.g. news1"
           value="{{ filename ? filename|split('_')[0] : '' }}">
    <br><br>

    <textarea id="{{ editor_id }}" name="{{ editor_name }}">{{ content|raw }}</textarea>
    <br><br>

    <button type="submit">ðŸ’¾ Save</button>
</form>

<hr>

<h3>Load / Delete Saved File</h3>
<form action="{{ route('editor.load') }}" method="GET" style="display:inline;">
    <select id="filename" name="filename" onchange="this.form.submit()">
        <option value="">-- Select a file --</option>
        {% for file in files %}
            <option value="{{ file }}" {% if filename == file %}selected{% endif %}>
                {{ file }}
            </option>
        {% endfor %}
    </select>
</form>

<form action="{{ route('editor.delete') }}" method="POST" style="display:inline;">
    {{ csrf_field() }}
    <input type="hidden" name="filename" id="delete_filename">
    <button type="submit" onclick="return confirm('Delete selected file?')">ðŸ—‘ Delete</button>
</form>

<script>
    // Set delete hidden input when dropdown changes
    const dropdown = document.getElementById('filename');
    const deleteInput = document.getElementById('delete_filename');
    dropdown.addEventListener('change', function() {
        deleteInput.value = this.value;
    });
</script>

<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
    tinymce.init({
        selector: '#{{ editor_id }}',
        height: 400,
        plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen',
        toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
        automatic_uploads: true,
        paste_data_images: true,
        images_reuse_filename: true,
        images_upload_handler: function(blobInfo, success, failure) {
            const csrf = document.querySelector('meta[name="csrf-token"]').content;
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '{{ route('tinymce.upload') }}');
            xhr.setRequestHeader('X-CSRF-TOKEN', csrf);

            xhr.onload = function() {
                if (xhr.status !== 200) return failure('HTTP Error: ' + xhr.status);
                const json = JSON.parse(xhr.responseText);
                if (!json || typeof json.location !== 'string') return failure('Invalid JSON: ' + xhr.responseText);
                success(json.location);
            };

            const formData = new FormData();
            formData.append('file', blobInfo.blob(), blobInfo.filename());
            xhr.send(formData);
        }
    });
</script>
