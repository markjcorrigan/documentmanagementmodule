@extends('jokes.layout')

@section('title', 'All Jokes')

@section('content')
    <div class="page-header">
        <h1>All Jokes</h1>
    </div>

    <!-- Random Joke Section -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-dice-5"></i> Random Joke of the Moment</h5>
            <button id="get-random-joke" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Get Another Joke
            </button>
        </div>
        <div class="card-body" id="random-joke-container">
            <div class="text-center text-muted py-4">
                <i class="bi bi-dice-5 fs-1"></i>
                <p class="mt-2">Click the button above to get a random joke!</p>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <!-- Search Form -->
            <form action="{{ route('jokes.index') }}" method="GET" class="d-flex">
                <input type="text" name="s" class="form-control me-2"
                       placeholder="Search jokes..."
                       value="{{ request('s') }}">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
            </form>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ route('jokes.index', ['favorites' => 1]) }}"
               class="btn {{ request('favorites') ? 'btn-warning' : 'btn-outline-warning' }}">
                <i class="bi bi-star-fill"></i>
                {{ request('favorites') ? 'Showing Favorites' : 'Show Favorites' }}
            </a>

            <a href="{{ route('jokes.create') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Create Joke
            </a>

            @if(auth()->user()->hasRole('Super Admin'))
                <a href="{{ route('jokes.export.csv') }}" class="btn btn-info">
                    <i class="bi bi-download"></i> Export CSV
                </a>
                <button id="delete-selected" class="btn btn-danger">
                    <i class="bi bi-trash"></i> Delete Selected
                </button>
            @endif
        </div>
    </div>

    @if($jokes->count() > 0)
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                <tr>
                    @if(auth()->user()->hasRole('Super Admin'))
                        <th style="width: 50px;">
                            <input type="checkbox" id="check-all">
                        </th>
                    @endif
                    <th style="width: 60px;">ID</th>
                    <th>Joke</th>
                    <th style="width: 150px;">Category</th>
                    <th style="width: 80px;">Status</th>
                    <th style="width: 80px;">Favorite</th>
                    <th style="width: 150px;">Created</th>
                    <th style="width: 250px;">Actions</th>
                </tr>
                </thead>
                <tbody>
                @foreach($jokes as $joke)
                    <tr>
                        <td>
                            <input type="checkbox" class="joke-checkbox" value="{{ $joke->id }}">
                        </td>
                        <td>{{ $joke->id }}</td>
                        <td>
                            <strong>{{ Str::limit($joke->title, 100) }}</strong>
                            @if($joke->description)
                                <br><small class="text-muted">{{ Str::limit($joke->description, 150) }}</small>
                            @endif
                        </td>
                        <td>
                            @if($joke->jokecat)
                                <a href="{{ route('jokes.category', $joke->jokecat->id) }}" class="badge bg-secondary">
                                    {{ $joke->jokecat->name }}
                                </a>
                            @else
                                <span class="badge bg-secondary">N/A</span>
                            @endif
                        </td>
                        <td>
                            @if($joke->is_ok)
                                <span class="badge bg-success">Approved</span>
                            @else
                                <span class="badge bg-warning">Pending</span>
                            @endif
                        </td>
                        <td class="text-center">
                            @auth
                                <button class="btn btn-sm toggle-favorite {{ $joke->isFavoritedByUser() ? 'btn-warning' : 'btn-outline-warning' }}"
                                        data-id="{{ $joke->id }}"
                                        title="{{ $joke->isFavoritedByUser() ? 'Remove from favorites' : 'Add to favorites' }}">
                                    <i class="bi bi-star{{ $joke->isFavoritedByUser() ? '-fill' : '' }}"></i>
                                </button>
                            @else
                                <button class="btn btn-sm btn-outline-warning"
                                        onclick="alert('Please login to favorite jokes')"
                                        title="Login to favorite">
                                    <i class="bi bi-star"></i>
                                </button>
                            @endauth
                        </td>
                        <td>{{ $joke->created_at->format('Y-m-d') }}</td>
                        <td>
                            <a href="{{ route('jokes.show', $joke) }}" class="btn btn-sm btn-info" title="View">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ route('jokes.edit', $joke) }}" class="btn btn-sm btn-warning" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-joke"
                                    data-id="{{ $joke->id }}"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                @endforeach
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if($jokes->hasPages())
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing {{ $jokes->firstItem() }} to {{ $jokes->lastItem() }} of {{ $jokes->total() }} jokes
                </div>
                <div>
                    <nav aria-label="Jokes pagination">
                        <ul class="pagination mb-0">
                            {{-- Previous Page Link --}}
                            @if($jokes->onFirstPage())
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo; Previous</span>
                                </li>
                            @else
                                <li class="page-item">
                                    <a class="page-link" href="{{ $jokes->previousPageUrl() }}" rel="prev">&laquo; Previous</a>
                                </li>
                            @endif

                            {{-- Pagination Elements --}}
                            @php
                                $elements = $jokes->links()->elements;
                            @endphp
                            @if(!empty($elements) && isset($elements[0]))
                                @foreach($elements[0] as $page => $url)
                                    @if($page == $jokes->currentPage())
                                        <li class="page-item active">
                                            <span class="page-link">{{ $page }}</span>
                                        </li>
                                    @else
                                        <li class="page-item">
                                            <a class="page-link" href="{{ $url }}">{{ $page }}</a>
                                        </li>
                                    @endif
                                @endforeach
                            @endif

                            {{-- Next Page Link --}}
                            @if($jokes->hasMorePages())
                                <li class="page-item">
                                    <a class="page-link" href="{{ $jokes->nextPageUrl() }}" rel="next">Next &raquo;</a>
                                </li>
                            @else
                                <li class="page-item disabled">
                                    <span class="page-link">Next &raquo;</span>
                                </li>
                            @endif
                        </ul>
                    </nav>
                </div>
            </div>
        @endif
    @else
        <div class="alert alert-info">
            <strong>No jokes found!</strong>
            @if(request('s'))
                Try a different search term.
            @else
                <a href="{{ route('jokes.create') }}">Create your first joke</a>
            @endif
        </div>
    @endif

@endsection

@push('styles')
<style>
    /* Yellow sun icon for light mode */
    [data-theme="light"] .theme-toggle .bi-sun-fill {
        color: #ffc107 !important;
    }
    
    /* Ensure moon icon stays visible in dark mode */
    [data-theme="dark"] .theme-toggle .bi-moon-fill {
        color: #cbd5e1 !important;
    }
</style>
@endpush

@push('scripts')
    <script>
        $(document).ready(function() {
            // Theme Switcher - Initialize and handle theme changes
            function initThemeSwitcher() {
                // Get theme from localStorage or default to 'light'
                let currentTheme = localStorage.getItem('theme') || 'light';
                
                // Apply theme on page load
                applyTheme(currentTheme);
                
                // Listen for theme toggle button clicks
                $(document).on('click', '.theme-toggle', function(e) {
                    e.preventDefault();
                    
                    // Toggle theme
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    // Save to localStorage
                    localStorage.setItem('theme', currentTheme);
                    
                    // Apply the theme
                    applyTheme(currentTheme);
                });
            }
            
            function applyTheme(theme) {
                // Update data-theme attribute on html element
                document.documentElement.setAttribute('data-theme', theme);
                
                // Update flux:appearance if using Flux
                if (typeof Flux !== 'undefined') {
                    document.documentElement.setAttribute('flux:appearance', theme);
                }
                
                // Update theme variable for use elsewhere
                window.currentTheme = theme;
                
                // Dispatch custom event for other scripts
                window.dispatchEvent(new CustomEvent('themeChanged', { 
                    detail: { theme: theme }
                }));
                
                // Update the toggle button icon if it exists
                const toggleBtn = $('.theme-toggle');
                if (toggleBtn.length) {
                    const icon = toggleBtn.find('i');
                    if (theme === 'dark') {
                        icon.removeClass('bi-sun-fill').addClass('bi-moon-fill');
                    } else {
                        icon.removeClass('bi-moon-fill').addClass('bi-sun-fill');
                    }
                }
            }
            
            // Initialize theme switcher
            initThemeSwitcher();

            // Get random joke
            $('#get-random-joke').on('click', function() {
                const button = $(this);
                const container = $('#random-joke-container');

                // Disable button and show loading
                button.prop('disabled', true);
                button.html('<span class="spinner-border spinner-border-sm" role="status"></span> Loading...');

                $.ajax({
                    url: '{{ route("jokes.random") }}',
                    type: 'GET',
                    success: function(response) {
                        if (response.success) {
                            const joke = response.joke;
                            const favoriteIcon = joke.is_favorite ? 'bi-star-fill text-warning' : 'bi-star';

                            container.html(`
                        <div class="joke-content">
                            <h4 class="mb-3">${joke.title}</h4>
                            ${joke.description ? `<p class="text-muted mb-3">${joke.description}</p>` : ''}
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary me-2">
                                        <i class="bi bi-tag"></i> ${joke.category}
                                    </span>
                                    <i class="bi ${favoriteIcon}"></i>
                                </div>
                                <a href="${joke.url}" class="btn btn-sm btn-outline-primary">
                                    View Full Joke <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    `);

                            // Animate the joke appearance
                            container.hide().fadeIn(400);
                        }
                    },
                    error: function(xhr) {
                        container.html(`
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        No jokes available. <a href="{{ route('jokes.create') }}">Create one now!</a>
                    </div>
                `);
                    },
                    complete: function() {
                        // Re-enable button
                        button.prop('disabled', false);
                        button.html('<i class="bi bi-arrow-clockwise"></i> Get Another Joke');
                    }
                });
            });

            // Auto-load a random joke on page load
            $('#get-random-joke').trigger('click');

            // Check/Uncheck all checkboxes
            $('#check-all').on('click', function() {
                $('.joke-checkbox').prop('checked', $(this).prop('checked'));
            });

            // Toggle favorite
            $('.toggle-favorite').on('click', function() {
                const button = $(this);
                const jokeId = button.data('id');

                $.ajax({
                    url: '/jokes/' + jokeId + '/toggle-favorite',
                    type: 'POST',
                    success: function(response) {
                        if (response.is_favorite) {
                            button.removeClass('btn-outline-warning').addClass('btn-warning');
                            button.find('i').removeClass('bi-star').addClass('bi-star-fill');
                            button.attr('title', 'Remove from favorites');
                        } else {
                            button.removeClass('btn-warning').addClass('btn-outline-warning');
                            button.find('i').removeClass('bi-star-fill').addClass('bi-star');
                            button.attr('title', 'Add to favorites');
                        }

                        // Show a brief success message
                        const toast = $('<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">' +
                            '<div class="toast show" role="alert">' +
                            '<div class="toast-body">' + response.message + '</div>' +
                            '</div></div>');
                        $('body').append(toast);
                        setTimeout(function() { toast.remove(); }, 2000);
                    },
                    error: function(xhr) {
                        alert('Error toggling favorite status');
                    }
                });
            });

            // Delete single joke
            $('.delete-joke').on('click', function() {
                const jokeId = $(this).data('id');

                if (confirm('Are you sure you want to delete this joke?')) {
                    $.ajax({
                        url: '/jokes/' + jokeId,
                        type: 'DELETE',
                        success: function(response) {
                            location.reload();
                        },
                        error: function(xhr) {
                            alert('Error deleting joke');
                        }
                    });
                }
            });

            // Delete selected jokes
            $('#delete-selected').on('click', function() {
                const selectedIds = $('.joke-checkbox:checked').map(function() {
                    return $(this).val();
                }).get();

                if (selectedIds.length === 0) {
                    alert('Please select at least one joke to delete');
                    return;
                }

                if (confirm('Are you sure you want to delete ' + selectedIds.length + ' joke(s)?')) {
                    $.ajax({
                        url: '{{ route("jokes.destroyMultiple") }}',
                        type: 'POST',
                        data: {
                            ids: selectedIds
                        },
                        success: function(response) {
                            location.reload();
                        },
                        error: function(xhr) {
                            alert('Error deleting jokes');
                        }
                    });
                }
            });
        });
    </script>
@endpush
