<?php

//use App\Helpers\ProtectedFiles;
use App\Http\Controllers\AuthenticatedSessionController;
use App\Http\Controllers\backend\AdminController;
use App\Http\Controllers\backend\BlogPostController;
use App\Http\Controllers\backend\CommentController;
use App\Http\Controllers\backend\HeroController;
use App\Http\Controllers\backend\PortfolioController;
use App\Http\Controllers\backend\ResumeController;
use App\Http\Controllers\backend\ServicesController;
use App\Http\Controllers\backend\SiteSettingsController;
use App\Http\Controllers\backend\SkillsController;
use App\Http\Controllers\backend\TestimonialController;
use App\Http\Controllers\DocumentController;
use App\Http\Controllers\DocumentDownloadController;
use App\Http\Controllers\EditorController;
use App\Http\Controllers\FileDemoController;
use App\Http\Controllers\frontend\FrontendController;
use App\Http\Controllers\frontend\UserPostsBlogPostController;
use App\Http\Controllers\ImageController;
use App\Http\Controllers\ImageDemoController;
use App\Http\Controllers\IndexController;
use App\Http\Controllers\JokecatController;
use App\Http\Controllers\JokeController;
use App\Http\Controllers\LegacyController;
use App\Http\Controllers\MailerController;
use App\Http\Controllers\PmboksixController;
use App\Http\Controllers\ProtectedFileController;
use App\Http\Controllers\StuffController;
use App\Http\Controllers\TinymceController;
use App\Http\Middleware\TransitionInterceptor;
use App\Livewire\AboutPmway;
use App\Livewire\Accelerate;
use App\Livewire\AcidDatabase;
use App\Livewire\AgileMethodsCarousel;
use App\Livewire\AgilevsTraditional;
use App\Livewire\AmericanFootball;
use App\Livewire\AmericanFootballVideos;
use App\Livewire\ATemplate;
use App\Livewire\Avatarform;
use App\Livewire\Blog\CreatePost;
use App\Livewire\Blog\EditPost;
use App\Livewire\Blog\ProfileFollowers;
use App\Livewire\Blog\ProfileFollowing;
use App\Livewire\Blog\ProfilePosts;
use App\Livewire\Blog\SinglePost;
use App\Livewire\Blog\Writefull;
use App\Livewire\BurndownShort;
use App\Livewire\CapabilityMaturityModel;
use App\Livewire\CategoriesManager;
use App\Livewire\Chat\ChatDashboard;
use App\Livewire\CmmiDevDashboard;
use App\Livewire\CMMiLanding;
use App\Livewire\CmmiLevelOne;
use App\Livewire\CrocodileHunter;
use App\Livewire\DocumentUploader;
use App\Livewire\DoneDone;
use App\Livewire\EthosLogosPathos;
use App\Livewire\FreedomsBarriersGoals;
use App\Livewire\GameStatsNew;
use App\Livewire\HamAndEggs;
use App\Livewire\Home;
use App\Livewire\KanbanCoffee;
use App\Livewire\LittlesLaw;
use App\Livewire\Livewireprocs;
use App\Livewire\NotesManager;
use App\Livewire\PersonalKanban;
use App\Livewire\PmbokProcessExample;
use App\Livewire\PmbokProcessNutshell;
use App\Livewire\Pmway\Itil\ItilFourPracticesLive;
use App\Livewire\Pmway\Laws;
use App\Livewire\PrivateOne;
use App\Livewire\ProductIncrement;
use App\Livewire\RedBeadExperiment;
use App\Livewire\ReleaseManagement;
use App\Livewire\SafeCritique;
use App\Livewire\Sbokfour;
use App\Livewire\ScrumDashboards;
use App\Livewire\Scrumfix;
use App\Livewire\ScrumSpike;
use App\Livewire\ScrumStudyVids;
use App\Livewire\SevenFs;
use App\Livewire\SevenRulesOfScrum;
use App\Livewire\SiteTransition;
use App\Livewire\Snowbird;
use App\Livewire\SpeedboatTool;
use App\Livewire\StudyMethods;
use App\Livewire\StyleGuide;
use App\Livewire\StyleGuideSimple;
use App\Livewire\ThePMWay;
use App\Livewire\VModel;
use App\Livewire\WorkCarousel;
use App\Livewire\WorkingSoftware;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Route;

use App\Livewire\LogsManager;
use App\Livewire\LogCategoriesManager;
use App\Livewire\VisitorAnalytics;

//protected storage alla deepseek
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
*/

// ========================================
// DIAGNOSTIC ROUTE - CHECK YOUR PERMISSIONS
// ========================================
Route::get('/check-my-permissions', function () {
    if (!auth()->check()) {
        return response()->json([
            'status' => '❌ NOT LOGGED IN',
            'message' => 'You must be logged in to check permissions'
        ]);
    }

    $user = auth()->user();
    $permissions = $user->getAllPermissions()->pluck('name')->toArray();
    $roles = $user->getRoleNames()->toArray();

    return response()->json([
        'status' => '✅ LOGGED IN',
        'user' => $user->name ?? $user->email,
        'user_id' => $user->id,
        'roles' => $roles,
        'all_permissions' => $permissions,
        'has_protected_storage_permission' => $user->can('protected storage'),
        'debug_info' => [
            'checking_for' => 'protected storage',
            'note' => 'Permission name is case-sensitive'
        ]
    ], 200, [], JSON_PRETTY_PRINT);
})->middleware('auth');

// ========================================
// 2. YOUR REGULAR APPLICATION ROUTES
// ========================================



/*
|--------------------------------------------------------------------------
| Logs Routes
|--------------------------------------------------------------------------
*/

Route::middleware(['auth', 'verified', 'permission:visitor analytics'])->group(function () {
    Route::get('/logs', LogsManager::class)->name('logs.index');
    Route::get('/logs/categories', LogCategoriesManager::class)->name('logs.categories');
    // Alternative: If you want a more RESTful structure
    // Route::prefix('logs')->name('logs.')->group(function () {
    //     Route::get('/', LogsManager::class)->name('index');
    // });

});

/*
|--------------------------------------------------------------------------
| Visitor Analytics
|--------------------------------------------------------------------------
*/



Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/logs', LogsManager::class)->name('logs.index');
    Route::get('/logs/categories', LogCategoriesManager::class)->name('logs.categories');
    Route::get('/visitor-analytics', VisitorAnalytics::class)->name('visitor.analytics');
});

/*
|--------------------------------------------------------------------------
| Public Routes
|--------------------------------------------------------------------------
*/

// Home & Main Landing
Route::get('/', Home::class)->name('home');
Route::get('/home', Home::class);

// Jokes Module (Home Page)
Route::prefix('jokes')->name('jokes.')->group(function () {
    Route::get('/', [JokeController::class, 'index'])->name('index');
    Route::get('/create', [JokeController::class, 'create'])->name('create');
    Route::post('/', [JokeController::class, 'store'])->name('store');
    Route::get('/random', [JokeController::class, 'random'])->name('random');
    Route::get('/{joke}', [JokeController::class, 'show'])->name('show');
    Route::get('/{joke}/edit', [JokeController::class, 'edit'])->name('edit');
    Route::put('/{joke}', [JokeController::class, 'update'])->name('update');
    Route::delete('/{joke}', [JokeController::class, 'destroy'])->name('destroy');
    Route::get('/category/{id}', [JokeController::class, 'byCategory'])->name('category');
    Route::post('/delete-multiple', [JokeController::class, 'destroyMultiple'])->name('destroyMultiple');
    Route::get('/export/csv', [JokeController::class, 'exportCsv'])->name('export.csv');
    Route::post('/{joke}/toggle-favorite', [JokeController::class, 'toggleFavorite'])->name('toggleFavorite');
});

// Joke Categories
Route::prefix('categories')->name('jokecats.')->group(function () {
    Route::get('/', [JokecatController::class, 'index'])->name('index');
    Route::get('/create', [JokecatController::class, 'create'])->name('create');
    Route::post('/', [JokecatController::class, 'store'])->name('store');
    Route::get('/{jokecat}/edit', [JokecatController::class, 'edit'])->name('edit');
    Route::put('/{jokecat}', [JokecatController::class, 'update'])->name('update');
    Route::delete('/{jokecat}', [JokecatController::class, 'destroy'])->name('destroy');
});

// Contact
Route::get('/contact', function () {
    return view('contact');
})->name('contact');

/*
|--------------------------------------------------------------------------
| BLOG ROUTES - All Consolidated Here
|--------------------------------------------------------------------------
*/

Route::prefix('blog')->name('blog.')->group(function () {

    // Public blog routes (everyone can view)
    Route::get('/post/{post}', SinglePost::class)->name('post');
    Route::get('/profile/{username}', ProfilePosts::class)->name('profile');
    Route::get('/profile/{username}/followers', ProfileFollowers::class)->name('profile.followers');
    Route::get('/profile/{username}/following', ProfileFollowing::class)->name('profile.following');

    // Authenticated blog routes
    Route::middleware(['auth'])->group(function () {
        // Following feed
        Route::get('/feed', Writefull::class)->name('feed');

        // Create post
        Route::get('/create', CreatePost::class)->name('create');

        // Edit post
        Route::get('/post/{post}/edit', EditPost::class)->name('edit');

        // Most voted posts
        Route::get('/most-voted', [FrontendController::class, 'MostVotedPosts'])->name('most.voted');
        Route::get('/top-voted', function () {
            return view('tailwind-most-voted');
        })->name('top.voted');
    });
});

// LEGACY BLOG ROUTES - Still in use (Bootstrap-based blog listing, portfolio, admin)
Route::get('/blog', [FrontendController::class, 'blog'])->name('blog');
Route::get('/post/details/{slug}', [FrontendController::class, 'BlogDetails']);
Route::get('/post/details/{id}', [FrontendController::class, 'BlogDetails']);
Route::post('store-comment', [FrontendController::class, 'StoreComment'])->name('store.comment');

// Legacy Most Voted (used by legacy blog views)
Route::get('/most-voted-posts', [FrontendController::class, 'MostVotedPosts'])->name('most.voted');

// Legacy Writestuff route (redirects to new blog feed)
Route::get('/writestuff', Writefull::class)->middleware('auth')->name('writestuff');

// OLD PROFILE ROUTES - Commented out (replaced by /blog/profile/* Livewire routes)
// Route::get('/profile/{user:name}', [UserController::class, 'profile']);
// Route::get('/profile/{user:name}/followers', [UserController::class, 'profileFollowers']);
// Route::get('/profile/{user:name}/following', [UserController::class, 'profileFollowing']);
// Route::post('/create-follow/{user:name}', [FollowController::class, 'createFollow']);
// Route::post('/remove-follow/{user:name}', [FollowController::class, 'removeFollow']);

/*
|--------------------------------------------------------------------------
| Style Guide & Templates
|--------------------------------------------------------------------------
*/

Route::get('/style-guide', StyleGuide::class);
Route::get('/style-guide-simple', StyleGuideSimple::class);
Route::get('/atemplate', ATemplate::class)->name('atemplate');

// =============================================
// PROTECTED FOLDERS - ADD YOUR FOLDERS HERE
// =============================================

/*
|--------------------------------------------------------------------------
| TRANSITION WARNING PAGE
|--------------------------------------------------------------------------
| This shows users a warning before entering legacy pages
*/
Route::get('/transition', SiteTransition::class)->name('site.transition');

/*
|--------------------------------------------------------------------------
| LIVEWIRE PAGES (Modern, Converted Pages)
|--------------------------------------------------------------------------
| These are the NEW Livewire versions that replace legacy pages
| No /home/ prefix, no transition middleware
*/

/*
|------------------------------------------------------------------------------------------------
| ROUTING STRUCTURE RULES FOR PMWAY FOR THE NEW LIVEWIRE STYLE GUIDE AND OLDER LEGACY PAGES BELOW
|------------------------------------------------------------------------------------------------
|
| RULE 1: ALL legacy Blade view pages MUST use /home/ prefix
| -----------------------------------------------------------
| Pattern: Route::get('/home/pagename', [IndexController::class, 'pagename']);
| Example: /home/itilsd, /home/measurement, /home/procrastination
| Purpose: Old pages that need transition warning before viewing
| Middleware: TransitionInterceptor (warns users about style changes)
| Views: Located in resources/views/Home/pagename.blade.php
|
| ✅ CORRECT:   /home/procrastination
| ❌ WRONG:     /procrastination (unless it's a Livewire component)
|
| RULE 2: NO /home/ prefix for MODERN Livewire pages
| ----------------------------------------------------
| Pattern: Route::get('/pagename', PagenameComponent::class);
| Example: /burndownshort, /product-increment, /agile-traditional
| Purpose: New converted pages with modern styling and Livewire features
| Middleware: None (no warning needed, these are the "good" pages)
| Views: Livewire components in app/Livewire/
|
| RULE 3: URL structure is STRICT - the prefix determines the type
| -----------------------------------------------------------------
| HAS /home/    → Legacy Blade view with transition warning
| NO /home/     → Modern Livewire component without warning
|
| Examples:
| ✅ /home/itilsd        → Legacy page (IndexController)
| ❌ /itilsd             → 404 (no route exists)
| ✅ /agile-traditional  → Modern page (Livewire)
| ✅ /home/procrastination → Legacy page (IndexController)
|
| RULE 4: NO EXCEPTIONS - consistency is key
| -------------------------------------------
| Every legacy page must follow the /home/ pattern
| This makes it easy to understand what type of page you're looking at
| and ensures the transition warning middleware works correctly
|
| RULE 5: File serving routes use different patterns
| ---------------------------------------------------
| PDFs:    /viewpdf/{filename} or /legacy/pdf/{filename}
| Videos:  /viewvideo/{subfolder}/{filename}
| Files:   /cmmidev/{path} (serves from public/cmmidev/)
| These use LegacyController and DON'T get transition warnings
|
| RULE 6: When to use which controller
| -------------------------------------
| IndexController:  Display legacy Blade views (pages with content)
| LegacyController: Serve files (PDFs, videos, downloads, static HTML)
|
| RULE 7: Duplicate content strategy
| -----------------------------------
| If a page exists in BOTH Livewire and legacy versions:
| - Livewire version: /pagename (preferred, link to this)
| - Legacy version:   /home/pagename (keep for backwards compatibility)
| Eventually, migrate all traffic to Livewire versions
|
*/

/*
 * REMINDER FOR FUTURE AI PROCESSING: These commented-out middleware routes in the section below are intentionally preserved for reference and should not be removed during any cleanup or formatting operations.
 * Please do ont delete them!
 */

// Route::get('/the-pmway', ThePMWay::class)->name('the-pmway')->middleware('auth');
Route::get('/the-pmway', ThePMWay::class)->name('the-pmway');

// Route::get('/gamestatsnew', GameStatsNew::class)->name('gamestatsnew')->middleware('auth');
Route::get('/gamestatsnew', GameStatsNew::class)->name('gamestatsnew');

// Route::get('/agile-traditional', AgilevsTraditional::class)->name('agile-traditional')->middleware('auth');
Route::get('/agile-traditional', AgilevsTraditional::class)->name('agile-traditional');

// Route::get('/scrumfix', Scrumfix::class)->name('scrumfix')->middleware('auth');
Route::get('/scrumfix', Scrumfix::class)->name('scrumfix');

// Route::get('/about-pmway', AboutPmway::class)->name('about-pmway')->middleware('auth');
Route::get('/about-pmway', AboutPmway::class)->name('about-pmway');

// Route::get('/cmmidevdashboard', CmmiDevDashboard::class)->name('cmmidevdashboard')->middleware('auth');
Route::get('/cmmidevdashboard', CmmiDevDashboard::class)->name('cmmidevdashboard');

// Route::get('/cmmi-landing', CMMiLanding::class)->name('cmmi-landing')->middleware('auth');
Route::get('/cmmi-landing', CMMiLanding::class)->name('cmmi-landing');

// Route::get('/cmmi-level-one', CmmiLevelOne::class)->name('cmmi-level-one')->middleware('auth');
Route::get('/cmmi-level-one', CmmiLevelOne::class)->name('cmmi-level-one');

// Route::get('/done-done', DoneDone::class)->name('done-done')->middleware('auth');
Route::get('/done-done', DoneDone::class)->name('done-done');

// Route::get('/crocodile-hunter', CrocodileHunter::class)->name('crocodile-hunter')->middleware('auth');
Route::get('/crocodile-hunter', CrocodileHunter::class)->name('crocodile-hunter');

// Route::get('/acid-database', AcidDatabase::class)->name('acid-database')->middleware('auth');
Route::get('/acid-database', AcidDatabase::class)->name('acid-database');

// Route::get('/ethos-logos-pathos', EthosLogosPathos::class)->name('ethos-logos-pathos')->middleware('auth');
Route::get('/ethos-logos-pathos', EthosLogosPathos::class)->name('ethos-logos-pathos');

// Route::get('/personal-kanban', PersonalKanban::class)->name('personal-kanban')->middleware('auth');
Route::get('/personal-kanban', PersonalKanban::class)->name('personal-kanban');

// Route::get('/laws', Laws::class)->name('laws')->middleware('auth');
Route::get('/laws', Laws::class)->name('laws');

// Route::get('/agile-methods', AgileMethodsCarousel::class)->name('agile.methods')->middleware('auth');
Route::get('/agile-methods', AgileMethodsCarousel::class)->name('agile.methods');

// Route::get('/red-bead-experiment', RedBeadExperiment::class)->name('red-bead-experiment')->middleware('auth');
Route::get('/red-bead-experiment', RedBeadExperiment::class)->name('red-bead-experiment');

// Route::get('/scrum-dashboards', ScrumDashboards::class)->name('scrum.dashboards')->middleware('auth');
Route::get('/scrum-dashboards', ScrumDashboards::class)->name('scrum.dashboards');

// Route::get('/pmbok-process-example', PmbokProcessExample::class)->name('pmbok.process.example')->middleware('auth');
Route::get('/pmbok-process-example', PmbokProcessExample::class)->name('pmbok.process.example');

// Route::get('/vmodel', VModel::class)->name('vmodel')->middleware('auth');
Route::get('/vmodel', VModel::class)->name('vmodel');

// Route::get('/burndownshort', BurndownShort::class)->name('burndownshort')->middleware('auth');
Route::get('/burndownshort', BurndownShort::class)->name('burndownshort');

// Route::get('/hamandeggs', HamAndEggs::class)->name('hamandeggs')->middleware('auth');
Route::get('/hamandeggs', HamAndEggs::class)->name('hamandeggs');

// Route::get('/kanbancoffee', KanbanCoffee::class)->name('kanban.coffee')->middleware('auth');
Route::get('/kanbancoffee', KanbanCoffee::class)->name('kanban.coffee');

// Route::get('/seven-rules-of-scrum', SevenRulesOfScrum::class)->name('seven-rules-of-scrum')->middleware('auth');
Route::get('/seven-rules-of-scrum', SevenRulesOfScrum::class)->name('seven-rules-of-scrum');

// Route::get('/accelerate', Accelerate::class)->name('accelerate')->middleware('auth');
Route::get('/accelerate', Accelerate::class)->name('accelerate');

// Route::get('/working-software', WorkingSoftware::class)->name('working.software')->middleware('auth');
Route::get('/working-software', WorkingSoftware::class)->name('working.software');

// Route::get('/release-management', ReleaseManagement::class)->name('release.management')->middleware('auth');
Route::get('/release-management', ReleaseManagement::class)->name('release.management');

// Route::get('/product-increment', ProductIncrement::class)->name('product.increment')->middleware('auth');
Route::get('/product-increment', ProductIncrement::class)->name('product.increment');

// Route::get('/safe-critique', SafeCritique::class)->name('safe.critique')->middleware('auth');
Route::get('/safe-critique', SafeCritique::class)->name('safe.critique');

// Route::get('/itilfourpracticeslive', ItilFourPracticeslive::class)->name('itilfourpracticeslive')->middleware('auth');
Route::get('/itilfourpracticeslive', ItilFourPracticeslive::class)->name('itilfourpracticeslive');

// Route::get('/snowbird', Snowbird::class)->name('snowbird')->middleware('auth');
Route::get('/snowbird', Snowbird::class)->name('snowbird');

// Route::get('/american-football', AmericanFootball::class)->name('american-football')->middleware('auth');
Route::get('/american-football', AmericanFootball::class)->name('american-football');

// Route::get('/american-football-videos', AmericanFootballVideos::class)->name('american-football.videos')->middleware('auth');
Route::get('/american-football-videos', AmericanFootballVideos::class)->name('american-football.videos');

// Route::get('/sevenfs', SevenFs::class)->name('sevenfs')->middleware('auth');
Route::get('/sevenfs', SevenFs::class)->name('sevenfs');

// Route::get('/sbok-four', Sbokfour::class)->name('sbok-four')->middleware('auth');
Route::get('/sbok-four', Sbokfour::class)->name('sbok-four');

// Route::get('/capability-maturity-model', CapabilityMaturityModel::class)->name('cmm')->middleware('auth');
Route::get('/capability-maturity-model', CapabilityMaturityModel::class)->name('cmm');

// Route::get('/study-methods', StudyMethods::class)->name('study-methods')->middleware('auth');
Route::get('/study-methods', StudyMethods::class)->name('study-methods');

// Route::get('/freedoms-barriers-goals', FreedomsBarriersGoals::class)->name('freedoms.barriers.goals')->middleware('auth');
Route::get('/freedoms-barriers-goals', FreedomsBarriersGoals::class)->name('freedoms.barriers.goals');

// Route::get('/speedboat-tool', SpeedboatTool::class)->name('speedboat.tool')->middleware('auth');
Route::get('/speedboat-tool', SpeedboatTool::class)->name('speedboat.tool');

// Route::get('/scrum-spike', ScrumSpike::class)->name('the.spike')->middleware('auth');
Route::get('/scrum-spike', ScrumSpike::class)->name('the.spike');

// Route::get('/littles-law', LittlesLaw::class)->name('littles-law')->middleware('auth');
Route::get('/littles-law', LittlesLaw::class)->name('littles-law');

// Route::get('/scrum-study-vids', ScrumStudyVids::class)->name('scrum-study-vids')->middleware('auth');
Route::get('/scrum-study-vids', ScrumStudyVids::class)->name('scrum-study-vids');

// Livewire search component for old blog
Route::get('/lwsearch', \App\Livewire\LWSearch::class)->name('lwsearch');

/*
|--------------------------------------------------------------------------
| LIVEWIRE COMPONENTS (Demo/Testing)
|--------------------------------------------------------------------------
*/
Route::get('/greeter', \App\Livewire\Greeter::class)->name('greeter');
Route::get('/livewireprocs', Livewireprocs::class)->name('livewireprocs');
Route::get('/calculator', \App\Livewire\Calculator::class)->name('calculator');
Route::get('/todo-list', \App\Livewire\TodoList::class)->name('todo-list');
Route::get('/cascading-dropdown', \App\Livewire\CascadingDropdown::class)->name('cascading-dropdown');
Route::get('/products', \App\Livewire\ProductsSearch::class)->name('products');
Route::get('/image-upload', \App\Livewire\ImageUpload::class)->name('image-upload');
Route::get('/registertest', \App\Livewire\RegisterForm::class)->name('registertest');

/*
|--------------------------------------------------------------------------
| LEGACY BLADE VIEW ROUTES (IndexController)
|--------------------------------------------------------------------------
| OLD pages with transition middleware warning
| These use /home/ prefix OR special routes like /procrastination
*/
Route::middleware([TransitionInterceptor::class])->group(function () {

    // ITIL Routes
    Route::get('/home/itilfourpractices', [IndexController::class, 'itilfourpractices']);
    Route::get('/home/itiloverview', [IndexController::class, 'itiloverview']);
    Route::get('/home/itilss', [IndexController::class, 'itilss']);
    Route::get('/home/itilsd', [IndexController::class, 'itilsd']);
    Route::get('/home/itilst', [IndexController::class, 'itilst']);
    Route::get('/home/itilso', [IndexController::class, 'itilso']);
    Route::get('/home/itilcsi', [IndexController::class, 'itilcsi']);
    Route::get('/home/itil', [IndexController::class, 'itil']);
    Route::get('/home/itilpm', [IndexController::class, 'itilpm']);

    // Scrum Routes
    Route::get('/home/scrumroleclarity', [IndexController::class, 'scrumroleclarity']);
    Route::get('/home/userstories', [IndexController::class, 'userstories']);
    Route::get('/home/mvp', [IndexController::class, 'mvp']);
    Route::get('/home/burndownshort', [IndexController::class, 'burndownshort']);
    Route::get('/home/productincrement', [IndexController::class, 'productincrement']);
    Route::get('/home/sprintupclose', [IndexController::class, 'sprintupclose']);
    Route::get('/home/sailboat', [IndexController::class, 'sailboat'])->name('sailboat');
    Route::get('/home/scrum', [IndexController::class, 'scrum']); // CHANGED: added /home/

    // SAFe Routes
    Route::get('/home/spo', [IndexController::class, 'spo']);
    Route::get('/home/ssm', [IndexController::class, 'ssm']);

    // Change Management Routes
    Route::get('/home/changeman', [IndexController::class, 'changeman']);
    Route::get('/home/changeadkar', [IndexController::class, 'changeadkar']);

    // Metrics & Measurement Routes
    Route::get('/home/measurement', [IndexController::class, 'measurement']);
    Route::get('/home/gamestats', [IndexController::class, 'gamestats'])->name('gamestats');
    Route::get('/home/removetheredbeads', [IndexController::class, 'removetheredbeads']);

    // Productivity Routes - NOW ALL HAVE /home/ PREFIX
    Route::get('/home/procrastination', [IndexController::class, 'procrastination']); // CHANGED
    Route::get('/home/recharge', [IndexController::class, 'recharge']);
    Route::get('/home/freedoms', [IndexController::class, 'freedoms']);
    Route::get('/home/monkey', [IndexController::class, 'monkey']);

    // Other Legacy Routes - NOW ALL HAVE /home/ PREFIX
    Route::get('/home/about', [IndexController::class, 'about']);
    Route::get('/home/baseline', [IndexController::class, 'baseline']); // CHANGED
    Route::get('/home/dml', [IndexController::class, 'dml']); // CHANGED
    Route::get('/home/test', [IndexController::class, 'test']); // CHANGED
});

/*
|--------------------------------------------------------------------------
| LEGACY FILE SERVING ROUTES (LegacyController)
|--------------------------------------------------------------------------
| Serves PDFs, videos, downloads from legacy structure
| NO transition middleware - these are direct file access
*/

// Legacy HTML pages catch-all (should be LAST in legacy section)
Route::get('/home/{page}', [LegacyController::class, 'show']);

// PDF viewing routes
Route::get('/viewpdf/{subfolder}/{filename}', [LegacyController::class, 'viewPdf']);
Route::get('/viewpdf/{filename}', [LegacyController::class, 'viewPdf']);
Route::get('/legacy/pdf/{subfolder}/{filename}', [LegacyController::class, 'viewPdf'])
    ->where('filename', '.*\.pdf');
Route::get('/legacy/pdf/{filename}', [LegacyController::class, 'viewPdf'])
    ->where('filename', '.*\.pdf');

// Video viewing routes
Route::get('/viewvideo/{subfolder}/{filename}', [LegacyController::class, 'viewVideo']);
Route::get('/legacy/video/{subfolder}/{filename}', [LegacyController::class, 'viewVideo'])
    ->where('filename', '.*\.(mp4|avi|mov|wmv)');

// Download routes
Route::get('/download/{subfolder}/{filename}', [LegacyController::class, 'download']);
Route::get('/downloadzip/{filename}', [LegacyController::class, 'downloadZip']);
Route::get('/legacy/download/{subfolder}/{filename}', [LegacyController::class, 'download']);
Route::get('/legacy/download-zip/{filename}', [LegacyController::class, 'downloadZip'])
    ->middleware('auth');

// Public file serving from cmmidev directory
Route::get('/cmmidev/{path}', [LegacyController::class, 'servePublicFile'])
    ->where('path', '.*');

// CMMI files from storage
Route::get('/cmmi/files/{path}', function ($path) {
    $filePath = storage_path('app/public/assets/cmmidev/'.$path);
    if (! file_exists($filePath)) {
        abort(404);
    }

    return response()->file($filePath);
})->where('path', '.*')->name('cmmi.files');

// View PDF for ITIL 4 guides
Route::get('/view-pdf/{filename}', function ($filename) {
    $filePath = base_path('resources/views/livewire/pmway/itil/itil4guides/'.$filename);
    if (file_exists($filePath)) {
        return response()->file($filePath);
    }
    abort(404);
});

// Individual legacy page route (if still needed)
Route::get('/cmmidevdash', [LegacyController::class, 'page'])->name('cmmidevdash');
/*
|--------------------------------------------------------------------------
| PMBOK Routes
|--------------------------------------------------------------------------
*/

Route::middleware(['auth'])->prefix('pmbok-spa')->name('pmbok.spa.')->group(function () {
    Route::get('/', \App\Livewire\PmbokSpa\Dashboard::class)->name('dashboard');
    Route::get('/projects', \App\Livewire\PmbokSpa\ProjectList::class)->name('projects');
    Route::get('/process/{processId}', \App\Livewire\PmbokSpa\ProcessPage::class)->name('process');
});

Route::get('/pmboknutshell', PmbokProcessNutshell::class)->name('pmboknutshell')->middleware('auth');

Route::middleware(['auth'])->prefix('pmboksix')->controller(PmboksixController::class)->group(function () {
    Route::get('initiate', 'initiate');
    Route::get('plan', 'plan');
    Route::get('execute', 'execute');
    Route::get('monitorandcontrol', 'monitorandcontrol');
    Route::get('close', 'close');
    Route::get('pmbokprocessnutshell', 'pmbokprocessnutshell');
    Route::get('pmnotes', 'pmnotes');
    Route::get('integration', 'integration');
    Route::get('communication', 'communication');
    Route::get('procurement', 'procurement');
    Route::get('quality', 'quality');
    Route::get('resource', 'resource');
    Route::get('risk', 'risk');
    Route::get('schedule', 'schedule');
    Route::get('scope', 'scope');
    Route::get('cost', 'cost');
    Route::get('stakeholder', 'stakeholder');

    foreach (['four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen'] as $prefix) {
        foreach (['one', 'two', 'three', 'four', 'five', 'six', 'seven'] as $suffix) {
            Route::get("{$prefix}{$suffix}", $prefix.$suffix);
        }
    }
});

/*
|--------------------------------------------------------------------------
| ITIL Routes
|--------------------------------------------------------------------------
*/

Route::get('/view-pdf/{filename}', function ($filename) {
    $filePath = base_path('resources/views/livewire/pmway/itil/itil4guides/'.$filename);

    return file_exists($filePath) ? response()->file($filePath) : abort(404);
});

Route::get('/itiloverview', [IndexController::class, 'itiloverview']);
Route::get('/itilss', [IndexController::class, 'itilss']);
Route::get('/itilsd', [IndexController::class, 'itilsd']);
Route::get('/itilst', [IndexController::class, 'itilst']);
Route::get('/itilso', [IndexController::class, 'itilst']);
Route::get('/itilcsi', [IndexController::class, 'itilcsi']);

/*
|--------------------------------------------------------------------------
| Chat Module
|--------------------------------------------------------------------------
*/

Route::get('/chat', ChatDashboard::class)->name('chat.index');


// Live chat diagnostic.  NB use xampp after maintenance script to kill cache it is holding onto.
Route::get('/chat', ChatDashboard::class)->name('chat.index');

// Reverb Configuration Test Route
Route::get('/reverb-config-test', function() {
    $envValues = [
        'BROADCAST_DRIVER' => env('BROADCAST_DRIVER'),
        'REVERB_APP_KEY' => env('REVERB_APP_KEY') ? substr(env('REVERB_APP_KEY'), 0, 8).'***' : 'NULL',
        'REVERB_APP_SECRET' => env('REVERB_APP_SECRET') ? substr(env('REVERB_APP_SECRET'), 0, 8).'***' : 'NULL',
        'REVERB_APP_ID' => env('REVERB_APP_ID'),
        'REVERB_HOST' => env('REVERB_HOST'),
        'REVERB_PORT' => env('REVERB_PORT'),
        'REVERB_SCHEME' => env('REVERB_SCHEME'),
    ];

    $configValues = [
        'broadcasting.default' => config('broadcasting.default'),
        'broadcasting.reverb.key' => config('broadcasting.connections.reverb.key') ? substr(config('broadcasting.connections.reverb.key'), 0, 8).'***' : 'NULL',
        'broadcasting.reverb.secret' => config('broadcasting.connections.reverb.secret') ? substr(config('broadcasting.connections.reverb.secret'), 0, 8).'***' : 'NULL',
        'broadcasting.reverb.app_id' => config('broadcasting.connections.reverb.app_id'),
        'broadcasting.reverb.host' => config('broadcasting.connections.reverb.options.host'),
        'broadcasting.reverb.port' => config('broadcasting.connections.reverb.options.port'),
        'broadcasting.reverb.scheme' => config('broadcasting.connections.reverb.options.scheme'),
    ];

    $cacheFiles = [
        'Config Cache' => file_exists(base_path('bootstrap/cache/config.php')) ? '✗ EXISTS' : '✓ Not cached',
        'Routes Cache' => file_exists(base_path('bootstrap/cache/routes-v7.php')) ? '✗ EXISTS' : '✓ Not cached',
    ];

    $envKey = env('REVERB_APP_KEY');
    $configKey = config('broadcasting.connections.reverb.key');
    $valuesMatch = ($envKey === $configKey && $envKey !== null);

    $status = $valuesMatch ? '✅ WORKING' : '❌ MISMATCH';
    $statusColor = $valuesMatch ? 'green' : 'red';

    return view('reverb-test', compact('envValues', 'configValues', 'cacheFiles', 'status', 'statusColor'));
})->middleware('auth')->name('reverb.test');
/*
|--------------------------------------------------------------------------
| Notes App
|--------------------------------------------------------------------------
*/

Route::middleware(['auth'])->group(function () {
    Route::get('/notes', NotesManager::class)->name('notes.index');
    Route::get('/notes/categories', CategoriesManager::class)->name('notes.categories');
});

/*
|--------------------------------------------------------------------------
| Portfolio/Resume/Frontend
|--------------------------------------------------------------------------
*/

Route::get('/portfolio', [FrontendController::class, 'portfolio'])->name('portfolio');
Route::get('/workcarousel', WorkCarousel::class);
Route::get('/mycv', \App\Livewire\CvIndex::class)->name('mycv')->middleware('permission:mycv noaccess');
Route::post('store-contact-message', [FrontendController::class, 'StoreContactMessage'])->name('store.contact.message');

/*
|--------------------------------------------------------------------------
| File Management & Downloads
|--------------------------------------------------------------------------
*/

Route::get('/download/assets/{filename}', function ($filename) {
    $filename = basename($filename);
    $filePath = storage_path('app/public/assets/'.$filename);

    if (! File::exists($filePath)) {
        abort(404, 'File not found');
    }

    $allowedExtensions = ['pdf', 'zip', 'doc', 'docx', 'xls', 'xlsx'];
    $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

    if (! in_array($extension, $allowedExtensions)) {
        abort(403, 'File type not allowed');
    }

    return response()->download($filePath);
})->middleware('auth')->name('download.asset');

Route::middleware(['auth'])->group(function () {
    Route::get('viewpdf/{subfolder}/{filename}', [IndexController::class, 'viewpdf'])
        ->where('filename', '.*')
        ->name('viewpdf');

    Route::get('viewvideo/{subfolder}/{filename}', [IndexController::class, 'viewvideo'])
        ->where('subfolder', '[^/]+')
        ->where('filename', '.*')
        ->name('viewvideo');

    Route::get('download/{subfolder}/{filename}', [IndexController::class, 'saveAction'])
        ->where('subfolder', '[^/]+')
        ->where('filename', '.*')
        ->name('download');

    Route::get('downloadzip/{filename}', [IndexController::class, 'downloadZip'])
        ->where('filename', '.*')
        ->name('downloadzip');

    Route::get('user-view/{subfolder}/{filename}', [IndexController::class, 'userViewFile'])
        ->name('user.view.file');

    Route::get('/download-pdf/{filename}', [IndexController::class, 'downloadPdf'])
        ->name('download.pdf');
});

Route::get('/myfile-demo', [FileDemoController::class, 'index'])->name('myfile-demo');
Route::delete('/myfile-demo/{id}', [FileDemoController::class, 'destroy'])->name('myfile-demo.destroy');
Route::get('/myfile-demo/file/{filename}', [FileDemoController::class, 'serve'])->name('myfile-demo.serve');

Route::get('/myimage-demo', [ImageDemoController::class, 'index'])->name('myimage-demo');
Route::delete('/myimage-demo/{id}', [ImageDemoController::class, 'destroy'])->name('myimage-demo.destroy');
Route::get('/myimage-demo/image/{imagename}', [ImageDemoController::class, 'serve'])->name('myimage-demo.serve');

Route::post('upload-file', [IndexController::class, 'uploadFile'])
    ->middleware(['auth', 'verified', 'permission:file demo']);

/*
|--------------------------------------------------------------------------
| TinyMCE & Editor
|--------------------------------------------------------------------------
*/

Route::post('/tinymce/upload', [TinymceController::class, 'upload'])->name('tinymce.upload');
Route::get('/editor/{filename?}', [EditorController::class, 'load'])->name('editor.load');
Route::post('/editor/save', [EditorController::class, 'save'])->name('editor.save');
Route::post('/editor/delete/{filename}', [EditorController::class, 'delete'])->name('editor.delete');

/*
|--------------------------------------------------------------------------
| Tailwind CSS Training
|--------------------------------------------------------------------------
*/

Route::get('/twcsstraining', \App\Livewire\TWCSSTraining::class)->name('twcsstraining');
Route::get('/twcsstraining/{file}', function ($file) {
    $path = public_path('twcsstraining/'.$file);

    return file_exists($path) ? response()->file($path) : abort(404);
})->where('file', '.*');

/*
|--------------------------------------------------------------------------
| Utility Routes
|--------------------------------------------------------------------------
*/

Route::view('/tailwind', 'tailwind')->name('tailwind');
Route::get('/simulate-500', function () {
    abort(500, 'Simulated 500 error');
});

/*
|--------------------------------------------------------------------------
| System Administration Routes
|--------------------------------------------------------------------------
*/

Route::get('/optimize', function () {
    $kernel = app()->make(Illuminate\Contracts\Console\Kernel::class);
    $commands = [
        'queue:restart' => 'Queue restarted',
        'cache:clear' => 'Cache cleared',
        'config:cache' => 'Config cached',
        'route:clear' => 'Routes cleared',
        'view:clear' => 'Views cleared',
        'optimize:clear' => 'Optimization cleared',
        'optimize' => 'Optimization completed',
        'config:clear' => 'Config cleared',
    ];

    foreach ($commands as $command => $message) {
        $kernel->call($command);
        echo "$message.\n";
        flush();
    }

    exec('composer dump-autoload', $output, $result);
    echo "Composer autoload dumped.\n";
    echo 'All optimization steps completed!';
    flush();
});

Route::get('routeslisting', function () {
    $routeCollection = Route::getRoutes();
    echo "<table style='width:100%'>";
    echo "<tr><td width='10%'><h4>HTTP Method</h4></td><td width='10%'><h4>Route</h4></td><td width='10%'><h4>Name</h4></td><td width='70%'><h4>Action</h4></td></tr>";
    foreach ($routeCollection as $value) {
        echo "<tr><td>{$value->methods()[0]}</td><td>{$value->uri()}</td><td>{$value->getName()}</td><td>{$value->getActionName()}</td></tr>";
    }
    echo '</table>';
});

Route::get('/route-cache', function () {
    try {
        $exitCode = Artisan::call('route:cache');

        return $exitCode === 0 ? 'Route cache generated!' : 'Error generating route cache: '.Artisan::output();
    } catch (\Exception $e) {
        return 'Error generating route cache: '.$e->getMessage();
    }
});

Route::get('/route-clear', function () {
    try {
        Artisan::call('route:clear');

        return 'Route cache cleared!';
    } catch (\Exception $e) {
        return 'Error clearing route cache: '.$e->getMessage();
    }
});

/*
|--------------------------------------------------------------------------
| Authenticated Routes
|--------------------------------------------------------------------------
*/

Route::middleware(['auth', 'verified'])->group(function () {

    // Dashboard
    Route::get('/dashboard', \App\Livewire\Dashboard::class)->name('dashboard');
    Route::get('/pmwaysearch', \App\Livewire\PMWaySearch::class)->name('pmwaysearch');
    Route::post('/forcelogout', [AuthenticatedSessionController::class, 'destroy'])->name('forcelogout');

    // Avatar Management
    Route::get('/manage-avatar', Avatarform::class);

    // Document Management
    Route::get('/document-uploads', [DocumentController::class, 'uploads'])->name('uploads')->middleware('permission:document uploads');
    Route::post('/document-upload', [DocumentController::class, 'upload'])->name('upload')->middleware('permission:document upload');
    Route::get('/documents', [DocumentController::class, 'documents'])->name('documents');
    Route::get('/downloadbyshortname/{shortname}', [DocumentController::class, 'downloadByShortName'])->name('downloadByShortName')->middleware('permission:download byshortname');
    Route::delete('/documents/{id}', [DocumentController::class, 'destroy'])->name('documents.destroy')->middleware('permission:documents destroy');
    Route::get('/documents/{id}/edit', [DocumentController::class, 'edit'])->name('documents.edit')->middleware('permission:documents edit');
    Route::put('/documents/{id}', [DocumentController::class, 'update'])->name('documents.update')->middleware('permission:documents update');
    Route::get('/docusearch/{term}', [DocumentController::class, 'search']);
    Route::get('/documents/{shortname}/download', [DocumentController::class, 'downloadByShortName'])->name('documents.download');

    // Image Management
    Route::get('/image-uploads', [ImageController::class, 'uploads'])->name('image-uploading')->middleware('permission:document uploads');
    Route::post('/image-upload', [ImageController::class, 'upload'])->name('uploading')->middleware('permission:image upload');
    Route::get('/images', [ImageController::class, 'images'])->name('images');
    Route::delete('/images/{id}', [ImageController::class, 'destroy'])->name('images.destroy')->middleware('permission:images destroy');
    Route::get('/images/{id}/edit', [ImageController::class, 'edit'])->name('images.edit')->middleware('permission:images edit');
    Route::put('/images/{id}', [ImageController::class, 'update'])->name('images.update')->middleware('permission:images update');
    Route::get('/images/{shortname}/download', [ImageController::class, 'downloadByShortName'])->name('images.download');

    // Protected Storage Management Routes
    Route::middleware(['auth', 'permission:protected storage'])->prefix('protected-management')->group(function () {
        Route::get('/', [ProtectedFileController::class, 'index'])->name('protected.index');
        Route::get('/{id}/edit', [ProtectedFileController::class, 'edit'])->name('protected.edit');
        Route::put('/{id}', [ProtectedFileController::class, 'update'])->name('protected.update');
        Route::delete('/{id}', [ProtectedFileController::class, 'destroy'])->name('protected.destroy');
        Route::get('/{id}/download', [ProtectedFileController::class, 'download'])->name('protected.download');
        Route::post('/upload', [ProtectedFileController::class, 'upload'])->name('protected.upload');
        Route::post('/create-folder', [ProtectedFileController::class, 'createFolder'])->name('protected.createFolder');
    });

    // OLD Blog Post Routes (Backend/Admin)
    Route::post('/update-post-status', [BlogPostController::class, 'updatePostStatus'])->name('update.post.status')->middleware('permission:blog approved');
    Route::get('/useraddpost', [UserPostsBlogPostController::class, 'UserAddPost'])->name('user.add.post');
    Route::post('/userstorepost', [UserPostsBlogPostController::class, 'UserStorePost'])->name('user.store.post');
    Route::get('/search', [UserPostsBlogPostController::class, 'usersearch'])->name('usersearch');
    Route::get('/post/details', [UserPostsBlogPostController::class, 'firstPost'])->name('first.post');

    Route::controller(BlogPostController::class)->group(function () {
        Route::get('all-post', 'AllPost')->middleware('permission:all post')->name('all.post');
        Route::get('/blogsbyauthor', 'blogsByAuthor')->middleware('permission:all postsbyauthor')->name('blogs.by.author');
        Route::get('add-post', 'AddPost')->middleware('permission:add post')->name('add.post');
        Route::post('store-post', 'StorePost')->middleware('permission:store post')->name('store.post');
        Route::get('edit-post/{id}', 'EditPost')->middleware('permission:edit post')->name('edit.post');
        Route::post('update-post/{id}', 'UpdatePost')->middleware('permission:update post')->name('update.post');
        Route::get('delete-post/{id}', 'DeletePost')->middleware('permission:delete post')->name('delete.post');
        Route::get('/post/{post}', 'viewSinglePost')->name('view.post');
        Route::get('/admin/post/{post}', 'viewSinglePost');
    });

    // Portfolio Dashboard
    Route::get('/portfoliodash', [AdminController::class, 'PortfolioDash'])->name('portfoliodash')->middleware('permission:portfolio dash');

    // Hero Section
    Route::controller(HeroController::class)->group(function () {
        Route::get('here-section', 'HeroSection')->name('hero.section')->middleware('permission:all hero');
        Route::post('update-here-section', 'UpdateHeroSection')->name('update.here.section')->middleware('permission:update hero');
    });

    // Services
    Route::controller(ServicesController::class)->group(function () {
        Route::get('all-services', 'AllServices')->name('all.services')->middleware('permission:all service');
        Route::get('add-service', 'AddService')->name('add.service')->middleware('permission:add service');
        Route::post('store-service', 'StoreService')->name('store.service')->middleware('permission:store service');
        Route::get('edit-service/{id}', 'EditService')->name('edit.service')->middleware('permission:edit service');
        Route::post('update-service', 'UpdateService')->name('update.service')->middleware('permission:update service');
        Route::get('delete-service/{id}', 'DeleteService')->name('delete.service')->middleware('permission:delete service');
    });

    // Portfolio/Recent Works
    Route::controller(PortfolioController::class)->group(function () {
        Route::get('all-recent-works', 'AllRecentWorks')->name('all.recent.works')->middleware('permission:all work');
        Route::get('all-work', 'AddWork')->name('add.work')->middleware('permission:add work');
        Route::post('store-work', 'StoreWork')->name('store.work')->middleware('permission:store work');
        Route::get('edit-word/{id}', 'EditWork')->name('edit.work')->middleware('permission:edit work');
        Route::post('update-work', 'UpdateWork')->name('update.work')->middleware('permission:update work');
        Route::get('delete-word/{id}', 'DeleteWork')->name('delete.work')->middleware('permission:delete work');
    });

    // Experience & Education
    Route::controller(ResumeController::class)->group(function () {
        Route::get('my-experience', 'MyExperience')->name('my.experience')->middleware('permission:all experience');
        Route::post('store-experience', 'StoreExperience')->name('store.experience')->middleware('permission:store experience');
        Route::get('edit-experience/{id}', 'EditExperience')->middleware('permission:edit experience');
        Route::post('update-experience', 'UpdateExperience')->name('update.experience')->middleware('permission:update experience');
        Route::get('delete-experience/{id}', 'DeleteExperience')->name('delete.experience')->middleware('permission:delete experience');
        Route::get('my-education', 'MyEducation')->name('my.education')->middleware('permission:all education');
    });

    // Skills
    Route::controller(SkillsController::class)->group(function () {
        Route::get('add-skill', 'AddSkill')->name('add.skill')->middleware('permission:add skill');
        Route::post('store-skill', 'StoreSkill')->name('store.skill')->middleware('permission:store skill');
        Route::get('all-skills', 'AllSkills')->name('all.skills')->middleware('permission:all skill');
        Route::get('edit-skill/{id}', 'EditSkill')->name('edit.skill')->middleware('permission:edit skill');
        Route::post('update-skill', 'UpdateSkill')->name('update.skill')->middleware('permission:update skill');
        Route::get('delete-skill/{id}', 'DeleteSkill')->name('delete.skill')->middleware('permission:delete skill');
    });

    // Testimonials
    Route::controller(TestimonialController::class)->group(function () {
        Route::get('add-testimony', 'AddTestimony')->name('add.testimony')->middleware('permission:add testimony');
        Route::post('store-testimony', 'StoreTestimony')->name('store.testimony')->middleware('permission:store testimony');
        Route::get('all-testimoies', 'AllTestimonies')->name('all.testimoies')->middleware('permission:all testimony');
        Route::get('edit-testimony/{id}', 'EditTestimony')->name('edit.testimony')->middleware('permission:edit testimony');
        Route::post('update-testimony', 'UpdateTestimony')->name('update.testimony')->middleware('permission:update testimony');
        Route::get('delete-testimony/{id}', 'DeleteTestimony')->name('delete.testimony')->middleware('permission:delete testimony');
    });

    // Comments & Contacts
    Route::controller(CommentController::class)->group(function () {
        Route::get('user-comments', 'UserComments')->name('user.comments');
        Route::post('comment-status-update', 'CommentStatusUpdate')->name('comment.status.update')->middleware('permission:update comment');
        Route::get('contact-message', 'ContactMessage')->name('contact.message')->middleware('permission:all contact');
        Route::get('delete-contact/{id}', 'DeleteContact')->name('delete.contact')->middleware('permission:delete contact');
    });

    // Site Settings
    Route::controller(SiteSettingsController::class)->group(function () {
        Route::get('site-settings', 'SiteSettings')->name('site.settings')->middleware('permission:all setting');
        Route::post('update-site-settings', 'UpdateSiteSettings')->name('update.site.settings')->middleware('permission:update setting');
    });


    // FilePond Document Manager
    Route::middleware(['role:Super User'])->group(function () {
        Route::get('/admin/upload-documents', DocumentUploader::class)->name('admin.upload.documents');
    });

    Route::get('/admin/document-manager', DocumentUploader::class)
        ->name('admin.document.manager')
        ->middleware('permission:manage documents');

    Route::get('/admin/documents/download', [DocumentDownloadController::class, 'download'])
        ->name('admin.download.document')
        ->middleware('permission:manage documents');

    Route::get('/admin/documents/view', [DocumentDownloadController::class, 'view'])
        ->name('admin.view.document')
        ->middleware('permission:manage documents');

    // Impersonation
    Route::post('/impersonate/{user}', [\App\Http\Controllers\ImpersonationController::class, 'store'])
        ->name('impersonate.store')
        ->middleware('permission:impersonate');
    Route::delete('/impersonate/stop', [\App\Http\Controllers\ImpersonationController::class, 'destroy'])
        ->name('impersonate.destroy');

    // Settings
    Route::redirect('settings', 'settings/profile');
    Route::get('settings/profile', \App\Livewire\Settings\Profile::class)->name('settings.profile');
    Route::get('settings/password', \App\Livewire\Settings\Password::class)->name('settings.password');
    Route::get('settings/appearance', \App\Livewire\Settings\Appearance::class)->name('settings.appearance');
    Route::get('settings/locale', \App\Livewire\Settings\Locale::class)->name('settings.locale');

    // Admin Routes
    Route::prefix('admin')->as('admin.')->group(function () {
        Route::get('/', \App\Livewire\Admin\Index::class)->name('index')->middleware('permission:access dashboard');
        Route::get('/users', \App\Livewire\Admin\Users::class)->name('users.index')->middleware('permission:view users');
        Route::get('/users/create', \App\Livewire\Admin\Users\CreateUser::class)->name('users.create')->middleware('permission:create users');
        Route::get('/users/{user}', \App\Livewire\Admin\Users\ViewUser::class)->name('users.show')->middleware('permission:view users');
        Route::get('/users/{user}/edit', \App\Livewire\Admin\Users\EditUser::class)->name('users.edit')->middleware('permission:update users');
        Route::get('/roles', \App\Livewire\Admin\Roles::class)->name('roles.index')->middleware('permission:view roles');
        Route::get('/roles/create', \App\Livewire\Admin\Roles\CreateRole::class)->name('roles.create')->middleware('permission:create roles');
        Route::get('/roles/{role}/edit', \App\Livewire\Admin\Roles\EditRole::class)->name('roles.edit')->middleware('permission:update roles');
        Route::get('/permissions', \App\Livewire\Admin\Permissions::class)->name('permissions.index')->middleware('permission:view permissions');
        Route::get('/permissions/create', \App\Livewire\Admin\Permissions\CreatePermission::class)->name('permissions.create')->middleware('permission:create permissions');
        Route::get('permissions/{permission}/edit', \App\Livewire\Admin\Permissions\EditPermission::class)->name('permissions.edit')->middleware('permission:update permissions');
    });

    // Protected Content
    Route::middleware('role:Super Admin')->group(function () {
        Route::get('/privateone', PrivateOne::class);
    });

    Route::get('/scrumvidlessons', [IndexController::class, 'scrumvidlessons']);
});

/*
|--------------------------------------------------------------------------
| Super User Only Routes
|--------------------------------------------------------------------------
*/

Route::middleware(['superuser'])->group(function () {
    Route::get('/stuffs/jokes/{filename}', [StuffController::class, 'show'])->where('filename', '.*');
});

Route::get('/admins-only', function () {
    return 'Only admins should be able to see this page';
})->middleware('can:visitAdminPages');

/*
|--------------------------------------------------------------------------
| PHPMailer Routes
|--------------------------------------------------------------------------
*/

Route::get('email', [MailerController::class, 'email'])->name('email');
Route::post('send-email', [MailerController::class, 'composeEmail'])->name('send-email');

/*
|--------------------------------------------------------------------------
| PROTECTED STORAGE ROUTES (Before the catch-all!)
|--------------------------------------------------------------------------
*/

Route::middleware(['auth', 'permission:protected storage'])->prefix('protected-storage')->group(function () {

    // Main Storage Access Page
    Route::get('/', function () {
        return view('protected-links');
    })->name('storage.home');

    // Storage Dashboard
    Route::get('/dashboard', function () {
        $resources = [
            'scientology' => 'Scientology',
            'freezonecourses' => 'FreeZone Courses',
            'helpme' => 'HelpMe',
            'lrh' => 'LRH',
            'studentmotivationpdf' => 'Student Motivation PDF',
            'studymanual' => 'Study Manual',
            'techdic' => 'Tech Dictionary',
            'scientologydict' => 'Scientology Dictionary',
            'technicaldictionary' => 'Technical Dictionary',
            'agile' => 'agile',
            'Pmi' => 'Pmi',
            'Scrumban' => 'Scrumban',
            'Scrummanual' => 'Scrummanual',
            'Scrummedia' => 'Scrummedia',
            'Search' => 'Search',
            'azure' => 'azure',
            'bigdata' => 'bigdata',
            'booklets' => 'booklets',
            'books' => 'books',
            'cobit' => 'cobit',
            'computing' => 'computing',
            'devops' => 'devops',
            'devopsmedia' => 'devopsmedia',
            'documents' => 'documents',
            'headfirst' => 'headfirst',
            'home' => 'home',
            'itil' => 'itil',
            'java' => 'java',
            'kanban' => 'kanban',
            'laravel' => 'laravel',
            'lean' => 'lean',
            'microsoft' => 'microsoft',
            'mor' => 'mor',
            'msp' => 'msp',
            'notil' => 'notil',
            'oop' => 'oop',
            'p3o' => 'p3o',
            'php' => 'php',
            'prince2' => 'prince2',
            'programming' => 'programming',
            'python' => 'python',
            'safe' => 'safe',
            'scrum' => 'scrum',
            'servicenow' => 'servicenow',
            'spc' => 'spc',
            'strategy' => 'strategy',
            'studynotes' => 'studynotes'
        ];

        $status = [];
        foreach ($resources as $key => $name) {
            $hasIndex = Storage::disk('protected')->exists("{$key}/index.html");
            $files = Storage::disk('protected')->allFiles($key);
            $fileCount = count($files);

            $status[] = [
                'name' => $name,
                'key' => $key,
                'has_index' => $hasIndex,
                'file_count' => $fileCount,
                'url' => route('storage.resource', ['resource' => $key]),
                'local_path' => "storage/protected/{$key}/"
            ];
        }

        return view('storage-dashboard', ['resources' => $status]);
    })->name('storage.dashboard');

    // Storage API Endpoints
    Route::prefix('api')->group(function () {
        Route::get('/status', function () {
            $resources = [
                'scientology' => 'Scientology',
                'freezonecourses' => 'FreeZone Courses',
                'helpme' => 'HelpMe',
                'lrh' => 'LRH',
                'studentmotivationpdf' => 'Student Motivation PDF',
                'studymanual' => 'Study Manual',
                'techdic' => 'Tech Dictionary',
                'scientologydict' => 'Scientology Dictionary',
                'technicaldictionary' => 'Technical Dictionary'
            ];

            $status = [];
            foreach ($resources as $key => $name) {
                $hasIndex = Storage::disk('protected')->exists("{$key}/index.html");
                $files = Storage::disk('protected')->allFiles($key);
                $fileCount = count($files);

                $totalSize = 0;
                foreach ($files as $file) {
                    $totalSize += Storage::disk('protected')->size($file);
                }

                $status[] = [
                    'key' => $key,
                    'name' => $name,
                    'has_index' => $hasIndex,
                    'file_count' => $fileCount,
                    'total_size' => $totalSize,
                    'url' => route('storage.resource', ['resource' => $key]),
                    'local_path' => "storage/protected/{$key}"
                ];
            }

            return response()->json([
                'success' => true,
                'resources' => $status,
                'timestamp' => now()->toDateTimeString()
            ]);
        })->name('storage.api.status');

        Route::post('/clear-cache/{resource}', function ($resource) {
            $validResources = ['scientology', 'freezonecourses', 'helpme', 'lrh',
                'studentmotivationpdf', 'studymanual', 'techdic',
                'scientologydict', 'technicaldictionary'];

            if (!in_array($resource, $validResources)) {
                return response()->json(['success' => false, 'message' => 'Invalid resource'], 400);
            }

            $files = Storage::disk('protected')->allFiles($resource);
            $deletedCount = 0;

            foreach ($files as $file) {
                Storage::disk('protected')->delete($file);
                $deletedCount++;
            }

            return response()->json([
                'success' => true,
                'message' => "Cleared {$deletedCount} files from {$resource}",
                'files_deleted' => $deletedCount
            ]);
        })->name('storage.api.clear-cache');
    });

// CATCH-ALL STORAGE RESOURCE ROUTE
    Route::get('/{resource}/{path?}', function (Request $request, $resource, $path = '') {
        $cleanPath = trim($path, '/');

        // Build the full file path
        if (empty($cleanPath)) {
            $basePath = $resource;
        } else {
            $basePath = $resource . '/' . $cleanPath;
        }

        Log::info("🚀 Accessing: {$basePath}");

        // Build possible file paths
        $possiblePaths = [];

        // Check if it's a directory (serve index.html)
        $possiblePaths[] = "{$basePath}/index.html";
        $possiblePaths[] = "{$basePath}/index.htm";

        // Check as direct file
        $possiblePaths[] = $basePath;

        // Check with extensions if no extension present
        if (!str_contains($basePath, '.')) {
            $possiblePaths[] = "{$basePath}.html";
            $possiblePaths[] = "{$basePath}.htm";
        }

        Log::info("🔍 Checking paths: " . json_encode($possiblePaths));

        foreach ($possiblePaths as $filePath) {
            if (Storage::disk('protected')->exists($filePath)) {
                Log::info("✅ Found file: {$filePath}");

                $fullPath = Storage::disk('protected')->path($filePath);
                $extension = strtolower(pathinfo($filePath, PATHINFO_EXTENSION));

                $mimeTypes = [
                    'html' => 'text/html',
                    'htm' => 'text/html',
                    'css' => 'text/css',
                    'js' => 'application/javascript',
                    'jpg' => 'image/jpeg',
                    'jpeg' => 'image/jpeg',
                    'png' => 'image/png',
                    'gif' => 'image/gif',
                    'svg' => 'image/svg+xml',
                    'webp' => 'image/webp',
                    'ico' => 'image/x-icon',
                    'pdf' => 'application/pdf',
                    'txt' => 'text/plain',
                    'zip' => 'application/zip',
                    'rar' => 'application/x-rar-compressed',
                    '7z' => 'application/x-7z-compressed',
                    'mp3' => 'audio/mpeg',
                    'wav' => 'audio/wav',
                    'ogg' => 'audio/ogg',
                    'mp4' => 'video/mp4',
                    'webm' => 'video/webm',
                    'avi' => 'video/x-msvideo',
                ];

                $mimeType = $mimeTypes[$extension] ?? 'application/octet-stream';

                // Only force download for archives and executables
                $downloadExtensions = ['zip', 'rar', '7z', 'exe', 'dmg'];
                $disposition = in_array($extension, $downloadExtensions) ? 'attachment' : 'inline';

                // For HTML files, inject base tag to fix relative links
                if (in_array($extension, ['html', 'htm'])) {
                    $content = file_get_contents($fullPath);

                    // Calculate the base URL for this file
                    $baseUrl = url('/protected-storage/' . dirname($filePath));
                    if (dirname($filePath) === '.') {
                        $baseUrl = url('/protected-storage/' . $resource);
                    }

                    // Inject base tag after <head>
                    $baseTag = '<base href="' . $baseUrl . '/">';
                    $content = preg_replace('/(<head[^>]*>)/i', '$1' . $baseTag, $content);

                    return response($content, 200)
                        ->header('Content-Type', $mimeType)
                        ->header('Content-Disposition', $disposition);
                }

                // For audio/video files, add range support for seeking
                if (in_array($extension, ['mp3', 'mp4', 'wav', 'ogg', 'webm', 'avi'])) {
                    return response()->file($fullPath, [
                        'Content-Type' => $mimeType,
                        'Content-Disposition' => 'inline',
                        'Accept-Ranges' => 'bytes',
                    ]);
                }

                // All other files
                return response()->file($fullPath, [
                    'Content-Type' => $mimeType,
                    'Content-Disposition' => $disposition,
                ]);
            }
        }

        // Not found
        Log::error("❌ File not found. Checked: " . json_encode($possiblePaths));
        return response("File not found: {$basePath}<br><br>Checked:<br>" . implode('<br>', $possiblePaths), 404);

    })->where('path', '.*')->name('storage.resource');
});

/*
|--------------------------------------------------------------------------
| Dynamic Page Loader (Keep Last - This is a catch-all!)
|--------------------------------------------------------------------------
*/

Route::get('home/{page}', [IndexController::class, 'homePage'])->where('page', '.*');

require __DIR__.'/auth.php';